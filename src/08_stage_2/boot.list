     1                                  ;************************************************************************
     2                                  ;	BIOSでロードされる最初のセクタ
     3                                  ;	
     4                                  ;	プログラム全体を通して、セグメントの値は0x0000とする。
     5                                  ;	(DS==ES==0)
     6                                  ;	
     7                                  ;************************************************************************
     8                                  		BOOT_LOAD	equ		0x7C00				; ブートプログラムのロード位置
     9                                  
    10                                  		ORG		BOOT_LOAD						; ロードアドレスをアセンブラに指示
    11                                  
    12                                  ;************************************************************************
    13                                  ;	マクロ
    14                                  ;************************************************************************
    15                                  %include	"../include/macro.s"
    16                              <1> %macro cdecl 1-*.nolist
    17                              <1> 
    18                              <1>     %rep %0 - 1
    19                              <1>         push    %{-1:-1}
    20                              <1>         %rotate -1
    21                              <1>     %endrep
    22                              <1>     %rotate -1
    23                              <1> 
    24                              <1>         call    %1
    25                              <1> 
    26                              <1>     %if 1 < %0
    27                              <1>         add     sp,(__BITS__ >> 3) * (%0 - 1)
    28                              <1>     %endif
    29                              <1> 
    30                              <1> %endmacro
    16                                  
    17                                  ;************************************************************************
    18                                  ;	エントリポイント
    19                                  ;************************************************************************
    20                                  entry:
    21                                  		;---------------------------------------
    22                                  		; BPB(BIOS Parameter Block)
    23                                  		;---------------------------------------
    24 00000000 EB58                    		jmp		ipl								; IPLへジャンプ
    25 00000002 90<rep 58h>             		times	90 - ($ - $$) db 0x90			; 
    26                                  
    27                                  		;---------------------------------------
    28                                  		; IPL(Initial Program Loader)
    29                                  		;---------------------------------------
    30                                  ipl:
    31 0000005A FA                      		cli										; // 割り込み禁止
    32                                  
    33 0000005B B80000                  		mov		ax, 0x0000						; AX = 0x0000;
    34 0000005E 8ED8                    		mov		ds, ax							; DS = 0x0000;
    35 00000060 8EC0                    		mov		es, ax							; ES = 0x0000;
    36 00000062 8ED0                    		mov		ss, ax							; SS = 0x0000;
    37 00000064 BC007C                  		mov		sp, BOOT_LOAD					; SP = 0x7C00;
    38                                  
    39 00000067 FB                      		sti										; // 割り込み許可
    40                                  
    41 00000068 8816[B800]              		mov		[BOOT.DRIVE], dl				; ブートドライブを保存
    42                                  
    43                                  		;---------------------------------------
    44                                  		; 文字列を表示
    45                                  		;---------------------------------------
    46 0000006C 68[9800]E8480083C4-     		cdecl	puts, .s0						; puts(.s0);
    46 00000074 02                 
    47                                  
    48                                  		;---------------------------------------
    49                                  		; 次の512バイトを読み込む
    50                                  		;---------------------------------------
    51 00000075 B402                    		mov		ah, 0x02						; AH = 読み込み命令
    52 00000077 B001                    		mov		al, 1							; AL = 読み込みセクタ数
    53 00000079 B90200                  		mov		cx, 0x0002						; CX = シリンダ/セクタ
    54 0000007C B600                    		mov		dh, 0x00						; DH = ヘッド位置
    55 0000007E 8A16[B800]              		mov		dl, [BOOT.DRIVE]				; DL = ドライブ番号
    56 00000082 BB007E                  		mov		bx, 0x7C00 + 512				; BX = オフセット
    57 00000085 CD13                    		int		0x13							; if (CF = BIOS(0x13, 0x02))
    58 00000087 730C                    .10Q:	jnc		.10E							; {
    59 00000089 68[A500]E82B0083C4-     .10T:	cdecl	puts, .e0						;	puts(.e0);
    59 00000091 02                 
    60 00000092 E84400                  		call	reboot							;	reboot(); // 再起動
    61                                  .10E:											; }
    62                                  
    63                                  		;---------------------------------------
    64                                  		; 次のステージへ移行
    65                                  		;---------------------------------------
    66 00000095 E96801                  		jmp		stage_2							; ブート処理の第2ステージ
    67                                  
    68                                  		;---------------------------------------
    69                                  		; データ
    70                                  		;---------------------------------------
    71 00000098 426F6F74696E672E2E-     .s0		db	"Booting...", 0x0A, 0x0D, 0
    71 000000A1 2E0A0D00           
    72 000000A5 4572726F723A736563-     .e0		db	"Error:sector read", 0
    72 000000AE 746F72207265616400 
    73                                  
    74 000000B7 00                      ALIGN 2, db 0
    75                                  BOOT:											; ブートドライブに関する情報
    76 000000B8 0000                    .DRIVE:			dw	0							; ドライブ番号
    77                                  
    78                                  ;************************************************************************
    79                                  ;	モジュール
    80                                  ;************************************************************************
    81                                  %include	"../modules/real/puts.s"
    82                              <1> puts:
    83                              <1>         ;---------------------------------------
    84                              <1>         ;   【スタックフレームの構築】
    85                              <1>         ;---------------------------------------
    86                              <1>                                                 ;    + 4 | 文字列へのアドレス
    87 000000BA 55                  <1>         push    bp                              ;    + 2 | (戻り番地)
    88 000000BB 89E5                <1>         mov     bp,sp                           ; BP + 0 | BP(元の値)
    89                              <1> 
    90                              <1>         ;----------------------------------------
    91                              <1>         ;   【レジスタの保存】
    92                              <1>         ;----------------------------------------
    93 000000BD 50                  <1>         push    ax
    94 000000BE 53                  <1>         push    bx
    95 000000BF 56                  <1>         push    si
    96                              <1> 
    97                              <1>         ;----------------------------------------
    98                              <1>         ;   引数を取得
    99                              <1>         ;----------------------------------------
   100 000000C0 8B7604              <1>         mov     si,[bp + 4]                     ; SI = 文字列へのアドレス
   101                              <1> 
   102                              <1>         ;----------------------------------------
   103                              <1>         ;   【処理の開始】
   104                              <1>         ;----------------------------------------
   105 000000C3 B40E                <1>         mov     ah,0x0E                         ; テレタイプ式1文字出力
   106 000000C5 BB0000              <1>         mov     bx,0x0000                       ; ページ番号と文字色を0に設定
   107 000000C8 FC                  <1>         cld                                     ; DF = 0(アドレス加算)
   108                              <1> 
   109                              <1> .10L:                                           ; do
   110 000000C9 AC                  <1>         lodsb                                   ;{
   111                              <1>                                                 ;   AL = *SI++;
   112 000000CA 3C00                <1>         cmp     al,0                            ;   if(0 == AL)
   113 000000CC 7404                <1>         je      .10E                            ;       break;
   114                              <1>                                                 ;
   115 000000CE CD10                <1>         int     0x10                            ;   Int10(0x0E,AL); 文字出力
   116 000000D0 EBF7                <1>         jmp     .10L                            ;
   117                              <1> .10E:                                           ;}while(1)
   118                              <1> 
   119                              <1>     ;--------------------------------------------
   120                              <1>     ;   【レジスタの復帰】
   121                              <1>     ;--------------------------------------------
   122 000000D2 5E                  <1>     pop     si
   123 000000D3 5B                  <1>     pop     bx
   124 000000D4 58                  <1>     pop     ax
   125                              <1> 
   126                              <1>     ;--------------------------------------------
   127                              <1>     ;   【スタックフレームの破棄】
   128                              <1>     ;--------------------------------------------
   129 000000D5 89EC                <1>     mov     sp,bp
   130 000000D7 5D                  <1>     pop     bp
   131                              <1> 
   132 000000D8 C3                  <1>     ret
    82                                  %include	"../modules/real/reboot.s"
    83                              <1> reboot:
    84                              <1>         ;------------------------------------
    85                              <1>         ;   メッセージを表示
    86                              <1>         ;------------------------------------
    87 000000D9 68[F500]E8DBFF83C4- <1>         cdecl   puts, .s0                   ;再起動メッセージを表示
    87 000000E1 02                  <1>
    88                              <1> 
    89                              <1>         ;-----------------------------------
    90                              <1>         ;   キー入力待ち
    91                              <1>         ;-----------------------------------
    92                              <1> .10L:
    93 000000E2 B410                <1>         mov     ah, 0x10
    94 000000E4 CD16                <1>         int     0x16
    95                              <1> 
    96 000000E6 3C20                <1>         cmp     al, ' '
    97 000000E8 75F8                <1>         jne     .10L
    98                              <1> 
    99                              <1>         ;----------------------------------
   100                              <1>         ;   改行を出力
   101                              <1>         ;----------------------------------
   102 000000EA 68[1301]E8CAFF83C4- <1>         cdecl   puts, .s1                  
   102 000000F2 02                  <1>
   103                              <1> 
   104                              <1>         ;----------------------------------
   105                              <1>         ;   再起動
   106                              <1>         ;----------------------------------
   107 000000F3 CD19                <1>         int     0x19                       ; BIOS(0x19) //reboot()
   108                              <1> 
   109                              <1>         ;----------------------------------
   110                              <1>         ;   文字列データ
   111                              <1>         ;----------------------------------
   112 000000F5 0A0D50757368205350- <1> .s0     db      0x0A, 0x0D, "Push SPACE KEY to reboot...", 0
   112 000000FE 414345204B45592074- <1>
   112 00000107 6F207265626F6F742E- <1>
   112 00000110 2E2E00              <1>
   113 00000113 0A0D0A0D00          <1> .s1     db      0x0A, 0x0D, 0x0A, 0x0D, 0
    83                                  
    84                                  ;************************************************************************
    85                                  ;	ブートフラグ（先頭512バイトの終了）
    86                                  ;************************************************************************
    87 00000118 00<rep E6h>             		times	510 - ($ - $$) db 0x00
    88 000001FE 55AA                    		db	0x55, 0xAA
    89                                  
    90                                  ;************************************************************************
    91                                  ;	ブート処理の第2ステージ
    92                                  ;************************************************************************
    93                                  stage_2:
    94                                  		;---------------------------------------
    95                                  		; 文字列を表示
    96                                  		;---------------------------------------
    97 00000200 68[0B02]E8B4FE83C4-     		cdecl	puts, .s0						; puts(.s0);
    97 00000208 02                 
    98                                  
    99                                  		;---------------------------------------
   100                                  		; 処理の終了
   101                                  		;---------------------------------------
   102 00000209 EBFE                    		jmp		$								; while (1) ; // 無限ループ
   103                                  
   104                                  		;---------------------------------------
   105                                  		; データ
   106                                  		;---------------------------------------
   107 0000020B 326E64207374616765-     .s0		db	"2nd stage...", 0x0A, 0x0D, 0
   107 00000214 2E2E2E0A0D00       
   108                                  
   109                                  ;************************************************************************
   110                                  ;	パディング（このファイルは8Kバイトとする）
   111                                  ;************************************************************************
   112 0000021A 00<rep 1DE6h>           		times (1024 * 8) - ($ - $$)		db	0		; 8Kバイト
   113                                  
