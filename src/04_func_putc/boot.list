     1                                          BOOT_LOAD   equ     0x7C00      ;ブートプログラムのロード位置
     2                                          ORG     BOOT_LOAD               ;ロードアドレスを指示
     3                                  
     4                                  ;******************************************************************
     5                                  ;   マクロ
     6                                  ;******************************************************************
     7                                  %include    "../include/macro.s"
     8                              <1> %macro cdecl 1-*.nolist
     9                              <1> 
    10                              <1>     %rep %0 - 1
    11                              <1>         push    %{-1:-1}
    12                              <1>         %rotate -1
    13                              <1>     %endrep
    14                              <1>     %rotate -1
    15                              <1> 
    16                              <1>         call    %1
    17                              <1> 
    18                              <1>     %if 1 < %0
    19                              <1>         add     sp,(__BITS__ >> 3) * (%0 - 1)
    20                              <1>     %endif
    21                              <1> 
    22                              <1> %endmacro
     8                                  
     9                                  ;******************************************************************
    10                                  ;   エントリポイント
    11                                  ;******************************************************************
    12                                  entry:
    13                                          ;------------------------------
    14                                          ;   BPB(BIOS Parameter Block)
    15                                          ;------------------------------
    16 00000000 EB58                            jmp     ipl
    17 00000002 90<rep 58h>                     times   90 - ($ - $$) db 0x90
    18                                  
    19                                          ;-------------------------------
    20                                          ;   IPL(Initial Program Loader)
    21                                          ;-------------------------------
    22                                  
    23                                  ipl:
    24 0000005A FA                              cli                             ;割り込み禁止
    25                                  
    26 0000005B B80000                          mov     ax,0x0000               ;AX = 0x0000;
    27 0000005E 8ED8                            mov     ds,ax                   ;DS = 0x0000;
    28 00000060 8EC0                            mov     es,ax                   ;ES = 0x0000;
    29 00000062 8ED0                            mov     ss,ax                   ;SS = 0x0000;
    30 00000064 BC007C                          mov     sp,BOOT_LOAD            ;SP = 0x7C00;
    31                                  
    32 00000067 FB                              sti                             ;割り込み許可
    33                                  
    34 00000068 8816[8600]                      mov     [BOOT.DRIVE],dl         ;ブートドライブを保存
    35                                  
    36                                          ;-------------------------------
    37                                          ;   文字を表示
    38                                          ;-------------------------------
    39 0000006C 6A58E8170083C402                cdecl   putc,word 'X'
    40 00000074 6A59E80F0083C402                cdecl   putc,word 'Y'
    41 0000007C 6A5AE8070083C402                cdecl   putc,word 'Z'
    42                                  
    43                                          ;-------------------------------
    44                                          ;       処理の終了
    45                                          ;-------------------------------
    46 00000084 EBFE                            jmp     $                       ;無限ループ
    47                                  
    48                                  ALIGN 2,db 0
    49                                  
    50                                  BOOT:                                   ;ブートドライブの情報
    51 00000086 0000                    .DRIVE:         dw 0                    ;ドライブ番号
    52                                  
    53                                  ;***************************************************************
    54                                  ;       モジュール
    55                                  ;***************************************************************
    56                                  %include        "../modules/real/putc.s"
    57                              <1> putc:
    58                              <1>         ;---------------------------------
    59                              <1>         ;   【スタックフレームの構築】
    60                              <1>         ;---------------------------------
    61                              <1>                                             ;    + 4| 出力文字
    62                              <1>                                             ;    + 2| IP(戻り番地)
    63 00000088 55                  <1>         push    bp                          ;  BP+ 0| BP(元の値)
    64 00000089 89E5                <1>         mov     bp,sp                       ; ------+-------------
    65                              <1> 
    66                              <1>         ;------------------------------------
    67                              <1>         ;【レジスタの保存】
    68                              <1>         ;------------------------------------
    69 0000008B 50                  <1>         push    ax
    70 0000008C 53                  <1>         push     bx
    71                              <1> 
    72                              <1>         ;------------------------------------
    73                              <1>         ;    【処理の開始】
    74                              <1>         ;------------------------------------
    75 0000008D 8A4604              <1>         mov     al,[bp + 4]                 ;   出力文字を取得
    76 00000090 B40E                <1>         mov     ah,0x0E                     ;テレタイプ式1文字出力
    77 00000092 BB0000              <1>         mov     bx,0x0000                   ;ページ番号と文字色を0に設定
    78 00000095 CD10                <1>         int     0x10                        ;ビデオBIOSコール
    79                              <1> 
    80                              <1>         ;-----------------------------------
    81                              <1>         ;   【レジスタの復帰】
    82                              <1>         ;-----------------------------------
    83 00000097 5B                  <1>         pop     bx
    84 00000098 58                  <1>         pop     ax
    85                              <1> 
    86                              <1>         ;-----------------------------------
    87                              <1>         ;   【スタックフレームの破棄】
    88                              <1>         ;-----------------------------------
    89 00000099 89EC                <1>         mov     sp,bp
    90 0000009B 5D                  <1>         pop     bp
    91                              <1> 
    92 0000009C C3                  <1>         ret
    57                                  
    58                                  ;***************************************************************
    59                                  ;       ブートフラグ
    60                                  ;***************************************************************
    61 0000009D 00<rep 161h>                    times   510 - ($ - $$) db 0x00
    62 000001FE 55AA                            db 0x55,0xAA
