     1                                  ;************************************************************************
     2                                  ;	BIOSでロードされる最初のセクタ
     3                                  ;	
     4                                  ;	プログラム全体を通して、セグメントの値は0x0000とする。
     5                                  ;	(DS==ES==0)
     6                                  ;	
     7                                  ;************************************************************************
     8                                  		BOOT_LOAD	equ		0x7C00				; ブートプログラムのロード位置
     9                                  
    10                                  		ORG		BOOT_LOAD						; ロードアドレスをアセンブラに指示
    11                                  
    12                                  ;************************************************************************
    13                                  ;	マクロ
    14                                  ;************************************************************************
    15                                  %include	"../include/macro.s"
    16                              <1> %macro cdecl 1-*.nolist
    17                              <1> 
    18                              <1>     %rep %0 - 1
    19                              <1>         push    %{-1:-1}
    20                              <1>         %rotate -1
    21                              <1>     %endrep
    22                              <1>     %rotate -1
    23                              <1> 
    24                              <1>         call    %1
    25                              <1> 
    26                              <1>     %if 1 < %0
    27                              <1>         add     sp,(__BITS__ >> 3) * (%0 - 1)
    28                              <1>     %endif
    29                              <1> 
    30                              <1> %endmacro
    16                                  
    17                                  ;************************************************************************
    18                                  ;	エントリポイント
    19                                  ;************************************************************************
    20                                  entry:
    21                                  		;---------------------------------------
    22                                  		; BPB(BIOS Parameter Block)
    23                                  		;---------------------------------------
    24 00000000 EB58                    		jmp		ipl								; IPLへジャンプ
    25 00000002 90<rep 58h>             		times	90 - ($ - $$) db 0x90			; 
    26                                  
    27                                  		;---------------------------------------
    28                                  		; IPL(Initial Program Loader)
    29                                  		;---------------------------------------
    30                                  ipl:
    31 0000005A FA                      		cli										; // 割り込み禁止
    32                                  
    33 0000005B B80000                  		mov		ax, 0x0000						; AX = 0x0000;
    34 0000005E 8ED8                    		mov		ds, ax							; DS = 0x0000;
    35 00000060 8EC0                    		mov		es, ax							; ES = 0x0000;
    36 00000062 8ED0                    		mov		ss, ax							; SS = 0x0000;
    37 00000064 BC007C                  		mov		sp, BOOT_LOAD					; SP = 0x7C00;
    38                                  
    39 00000067 FB                      		sti										; // 割り込み許可
    40                                  
    41 00000068 8816[9200]              		mov		[BOOT.DRIVE], dl				; ブートドライブを保存
    42                                  
    43                                  		;---------------------------------------
    44                                  		; 文字列を表示
    45                                  		;---------------------------------------
    46 0000006C 68[7A00]E8220083C4-     		cdecl	puts, .s0						; puts(.s0);
    46 00000074 02                 
    47                                  
    48                                  		;---------------------------------------
    49                                  		; 再起動
    50                                  		;---------------------------------------
    51 00000075 E83B00                  		cdecl	reboot							; // 戻ってこない
    52                                  
    53                                  		;---------------------------------------
    54                                  		; 処理の終了
    55                                  		;---------------------------------------
    56 00000078 EBFE                    		jmp		$								; while (1) ; // 無限ループ
    57                                  
    58                                  		;---------------------------------------
    59                                  		; データ
    60                                  		;---------------------------------------
    61 0000007A 426F6F74696E672E2E-     .s0		db	"Booting...", 0x0A, 0x0D, 0
    61 00000083 2E0A0D00           
    62 00000087 2D2D2D2D2D2D2D2D0A-     .s1		db	"--------", 0x0A, 0x0D, 0
    62 00000090 0D00               
    63                                  
    64                                  ALIGN 2, db 0
    65                                  BOOT:											; ブートドライブに関する情報
    66 00000092 0000                    .DRIVE:			dw	0							; ドライブ番号
    67                                  
    68                                  ;************************************************************************
    69                                  ;	モジュール
    70                                  ;************************************************************************
    71                                  %include	"../modules/real/puts.s"
    72                              <1> puts:
    73                              <1>         ;---------------------------------------
    74                              <1>         ;   【スタックフレームの構築】
    75                              <1>         ;---------------------------------------
    76                              <1>                                                 ;    + 4 | 文字列へのアドレス
    77 00000094 55                  <1>         push    bp                              ;    + 2 | (戻り番地)
    78 00000095 89E5                <1>         mov     bp,sp                           ; BP + 0 | BP(元の値)
    79                              <1> 
    80                              <1>         ;----------------------------------------
    81                              <1>         ;   【レジスタの保存】
    82                              <1>         ;----------------------------------------
    83 00000097 50                  <1>         push    ax
    84 00000098 53                  <1>         push    bx
    85 00000099 56                  <1>         push    si
    86                              <1> 
    87                              <1>         ;----------------------------------------
    88                              <1>         ;   引数を取得
    89                              <1>         ;----------------------------------------
    90 0000009A 8B7604              <1>         mov     si,[bp + 4]                     ; SI = 文字列へのアドレス
    91                              <1> 
    92                              <1>         ;----------------------------------------
    93                              <1>         ;   【処理の開始】
    94                              <1>         ;----------------------------------------
    95 0000009D B40E                <1>         mov     ah,0x0E                         ; テレタイプ式1文字出力
    96 0000009F BB0000              <1>         mov     bx,0x0000                       ; ページ番号と文字色を0に設定
    97 000000A2 FC                  <1>         cld                                     ; DF = 0(アドレス加算)
    98                              <1> 
    99                              <1> .10L:                                           ; do
   100 000000A3 AC                  <1>         lodsb                                   ;{
   101                              <1>                                                 ;   AL = *SI++;
   102 000000A4 3C00                <1>         cmp     al,0                            ;   if(0 == AL)
   103 000000A6 7404                <1>         je      .10E                            ;       break;
   104                              <1>                                                 ;
   105 000000A8 CD10                <1>         int     0x10                            ;   Int10(0x0E,AL); 文字出力
   106 000000AA EBF7                <1>         jmp     .10L                            ;
   107                              <1> .10E:                                           ;}while(1)
   108                              <1> 
   109                              <1>     ;--------------------------------------------
   110                              <1>     ;   【レジスタの復帰】
   111                              <1>     ;--------------------------------------------
   112 000000AC 5E                  <1>     pop     si
   113 000000AD 5B                  <1>     pop     bx
   114 000000AE 58                  <1>     pop     ax
   115                              <1> 
   116                              <1>     ;--------------------------------------------
   117                              <1>     ;   【スタックフレームの破棄】
   118                              <1>     ;--------------------------------------------
   119 000000AF 89EC                <1>     mov     sp,bp
   120 000000B1 5D                  <1>     pop     bp
   121                              <1> 
   122 000000B2 C3                  <1>     ret
    72                                  %include	"../modules/real/reboot.s"
    73                              <1> reboot:
    74                              <1>         ;------------------------------------
    75                              <1>         ;   メッセージを表示
    76                              <1>         ;------------------------------------
    77 000000B3 68[CF00]E8DBFF83C4- <1>         cdecl   puts, .s0                   ;再起動メッセージを表示
    77 000000BB 02                  <1>
    78                              <1> 
    79                              <1>         ;-----------------------------------
    80                              <1>         ;   キー入力待ち
    81                              <1>         ;-----------------------------------
    82                              <1> .10L:
    83 000000BC B410                <1>         mov     ah, 0x10
    84 000000BE CD16                <1>         int     0x16
    85                              <1> 
    86 000000C0 3C20                <1>         cmp     al, ' '
    87 000000C2 75F8                <1>         jne     .10L
    88                              <1> 
    89                              <1>         ;----------------------------------
    90                              <1>         ;   改行を出力
    91                              <1>         ;----------------------------------
    92 000000C4 68[ED00]E8CAFF83C4- <1>         cdecl   puts, .s1                  
    92 000000CC 02                  <1>
    93                              <1> 
    94                              <1>         ;----------------------------------
    95                              <1>         ;   再起動
    96                              <1>         ;----------------------------------
    97 000000CD CD19                <1>         int     0x19                       ; BIOS(0x19) //reboot()
    98                              <1> 
    99                              <1>         ;----------------------------------
   100                              <1>         ;   文字列データ
   101                              <1>         ;----------------------------------
   102 000000CF 0A0D50757368205350- <1> .s0     db      0x0A, 0x0D, "Push SPACE KEY to reboot...", 0
   102 000000D8 414345204B45592074- <1>
   102 000000E1 6F207265626F6F742E- <1>
   102 000000EA 2E2E00              <1>
   103 000000ED 0A0D0A0D00          <1> .s1     db      0x0A, 0x0D, 0x0A, 0x0D, 0
    73                                  
    74                                  ;************************************************************************
    75                                  ;	ブートフラグ（先頭512バイトの終了）
    76                                  ;************************************************************************
    77 000000F2 00<rep 10Ch>            		times	510 - ($ - $$) db 0x00
    78 000001FE 55AA                    		db	0x55, 0xAA
    79                                  
