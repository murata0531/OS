     1                                  ;************************************************************************
     2                                  ;	BIOSÇ≈ÉçÅ[ÉhÇ≥ÇÍÇÈç≈èâÇÃÉZÉNÉ^
     3                                  ;	
     4                                  ;	ÉvÉçÉOÉâÉÄëSëÃÇí ÇµÇƒÅAÉZÉOÉÅÉìÉgÇÃílÇÕ0x0000Ç∆Ç∑ÇÈÅB
     5                                  ;	(DS==ES==0)
     6                                  ;	
     7                                  ;************************************************************************
     8                                  
     9                                  ;************************************************************************
    10                                  ;	É}ÉNÉç
    11                                  ;************************************************************************
    12                                  %include	"../include/define.s"
    13                              <1> ;************************************************************************
    14                              <1> ;	„É°„É¢„É™„Ç§„É°„Éº„Ç∏
    15                              <1> ;************************************************************************
    16                              <1> 
    17                              <1> 		;---------------------------------------
    18                              <1> 		;           |            | 
    19                              <1> 		;           |____________| 
    20                              <1> 		; 0000_7A00 |            | ( 512) „Çπ„Çø„ÉÉ„ÇØ
    21                              <1> 		;           |____________| 
    22                              <1> 		; 0000_7C00 |            | (  8K) „Éñ„Éº„Éà
    23                              <1> 		;           =            = 
    24                              <1> 		;           |____________| 
    25                              <1> 		; 0000_9C00 |            | (  8K) „Ç´„Éº„Éç„É´Ôºà‰∏ÄÊôÇÂ±ïÈñãÔºâ
    26                              <1> 		;           =            = 
    27                              <1> 		;           |____________| 
    28                              <1> 		; 0000_BC00 |////////////| 
    29                              <1> 		;           =            = 
    30                              <1> 		;           |____________| 
    31                              <1> 		; 0010_0000 |       (2K) | Ââ≤„ÇäËæº„Åø„Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø„ÉÜ„Éº„Éñ„É´
    32                              <1> 		;           |____________| 
    33                              <1> 		; 0010_0800 |       (2K) | „Ç´„Éº„Éç„É´„Çπ„Çø„ÉÉ„ÇØ
    34                              <1> 		;           |____________| 
    35                              <1> 		; 0010_1000 |       (8K) | „Ç´„Éº„Éç„É´„Éó„É≠„Ç∞„É©„É†
    36                              <1> 		;           |            | 
    37                              <1> 		;           =            = 
    38                              <1> 		;           |____________| 
    39                              <1> 		; 0010_3000 |       (8K) | „Çø„Çπ„ÇØÁî®„Çπ„Çø„ÉÉ„ÇØ
    40                              <1> 		;           |            | ÔºàÂêÑ„Çø„Çπ„ÇØ1KÔºâ
    41                              <1> 		;           =            = 
    42                              <1> 		;           |____________| 
    43                              <1> 		; 0010_5000 |            | Dir
    44                              <1> 		;      6000 |____________| Page
    45                              <1> 		; 0010_7000 |            | Dir
    46                              <1> 		;      8000 |____________| Page
    47                              <1> 		; 0010_9000 |////////////| 
    48                              <1> 		;           |            | 
    49                              <1> 
    50                              <1> 
    51                              <1>         BOOT_SIZE			equ		(1024 * 8)		; „Éñ„Éº„Éà„Çµ„Ç§„Ç∫
    52                              <1> 		KERNEL_SIZE			equ		(1024 * 8)		; „Ç´„Éº„Éç„É´„Çµ„Ç§„Ç∫
    53                              <1> 
    54                              <1> 		BOOT_LOAD			equ		0x7C00			; „Éñ„Éº„Éà„Éó„É≠„Ç∞„É©„É†„ÅÆ„É≠„Éº„Éâ‰ΩçÁΩÆ
    55                              <1> 		BOOT_END			equ		(BOOT_LOAD + BOOT_SIZE)
    56                              <1> 
    57                              <1> 		KERNEL_LOAD			equ		0x0010_1000
    58                              <1> 
    59                              <1> 		SECT_SIZE			equ		(512)			; „Çª„ÇØ„Çø„Çµ„Ç§„Ç∫
    60                              <1> 
    61                              <1> 		BOOT_SECT			equ		(BOOT_SIZE   / SECT_SIZE)	; „Éñ„Éº„Éà„Éó„É≠„Ç∞„É©„É†„ÅÆ„Çª„ÇØ„ÇøÊï∞
    62                              <1> 		KERNEL_SECT			equ		(KERNEL_SIZE / SECT_SIZE)	; „Ç´„Éº„Éç„É´„ÅÆ„Çª„ÇØ„ÇøÊï∞
    63                              <1> 
    64                              <1> 		E820_RECORD_SIZE	equ		20
    65                              <1> 
    66                              <1> 		VECT_BASE			equ		0x0010_0000		;	0010_0000:0010_07FF
    13                                  %include	"../include/macro.s"
    14                              <1> ;************************************************************************
    15                              <1> ; Èñ¢Êï∞Âëº„Å≥Âá∫„ÅóÁî®„Éû„ÇØ„É≠
    16                              <1> ;
    17                              <1> ; ‰Ωø„ÅÑÊñπÔºö
    18                              <1> ;	cdecl	func [, param1[, param2[, ...]]]
    19                              <1> ;
    20                              <1> ;************************************************************************
    21                              <1> %macro  cdecl 1-*.nolist
    22                              <1> 
    23                              <1> 	%rep  %0 - 1
    24                              <1> 		push	%{-1:-1}
    25                              <1> 		%rotate -1
    26                              <1> 	%endrep 
    27                              <1> 	%rotate -1
    28                              <1> 
    29                              <1> 		call	%1
    30                              <1> 
    31                              <1> 	%if 1 < %0
    32                              <1> 		add		sp, (__BITS__ >> 3) * (%0 - 1)
    33                              <1> 	%endif
    34                              <1> 
    35                              <1> %endmacro
    36                              <1> 
    37                              <1> ;************************************************************************
    38                              <1> ; Ââ≤„ÇäËæº„Åø„Éô„ÇØ„ÇøË®≠ÂÆöÁî®
    39                              <1> ;
    40                              <1> ; ‰Ωø„ÅÑÊñπÔºö
    41                              <1> ;	set_vect	„Éô„ÇØ„ÇøÁï™Âè∑, Ââ≤„ÇäËæº„ÅøÂá¶ÁêÜ [, „Éï„É©„Ç∞]
    42                              <1> ;
    43                              <1> ;************************************************************************
    44                              <1> %macro  set_vect 1-*.nolist
    45                              <1> 		push	eax
    46                              <1> 		push	edi
    47                              <1> 
    48                              <1> 		mov		edi, VECT_BASE + (%1 * 8)		; „Éô„ÇØ„Çø„Ç¢„Éâ„É¨„Çπ;
    49                              <1> 		mov		eax, %2
    50                              <1> 
    51                              <1> 	%if 3 == %0
    52                              <1> 		mov		[edi + 4], %3					; „Éï„É©„Ç∞
    53                              <1> 	%endif
    54                              <1> 
    55                              <1> 		mov		[edi + 0], ax					; ‰æãÂ§ñ„Ç¢„Éâ„É¨„Çπ[15: 0]
    56                              <1> 		shr		eax, 16							; 
    57                              <1> 		mov		[edi + 6], ax					; ‰æãÂ§ñ„Ç¢„Éâ„É¨„Çπ[31:16]
    58                              <1> 
    59                              <1> 		pop		edi
    60                              <1> 		pop		eax
    61                              <1> %endmacro
    62                              <1> 
    63                              <1> ;************************************************************************
    64                              <1> ; „Éù„Éº„ÉàÂá∫ÂäõÁî®
    65                              <1> ;
    66                              <1> ; ‰Ωø„ÅÑÊñπÔºö
    67                              <1> ;	outp	„Éù„Éº„ÉàÁï™Âè∑, Âá∫ÂäõÂÄ§
    68                              <1> ;
    69                              <1> ;************************************************************************
    70                              <1> %macro  outp 2
    71                              <1> 		mov		al, %2
    72                              <1> 		out		%1, al
    73                              <1> %endmacro
    74                              <1> 
    75                              <1> ;************************************************************************
    76                              <1> ; „Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø„ÅÆÊÉÖÂ†±„ÇíË®≠ÂÆö
    77                              <1> ;
    78                              <1> ; ‰Ωø„ÅÑÊñπÔºö
    79                              <1> ;	set_desc	„Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø, „Éô„Éº„Çπ
    80                              <1> ;
    81                              <1> ;************************************************************************
    82                              <1> %macro  set_desc 2-* 
    83                              <1> 		push	eax
    84                              <1> 		push	edi
    85                              <1> 
    86                              <1> 		mov		edi, %1							; „Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø„Ç¢„Éâ„É¨„Çπ
    87                              <1> 		mov		eax, %2							; „Éô„Éº„Çπ„Ç¢„Éâ„É¨„Çπ
    88                              <1> 
    89                              <1> 	%if 3 == %0
    90                              <1> 		mov		[edi + 0], %3					; „É™„Éü„ÉÉ„Éà
    91                              <1> 	%endif
    92                              <1> 
    93                              <1> 		mov		[edi + 2], ax					; „Éô„Éº„ÇπÔºà[15: 0]Ôºâ
    94                              <1> 		shr		eax, 16							; 
    95                              <1> 		mov		[edi + 4], al					; „Éô„Éº„ÇπÔºà[23:16]Ôºâ
    96                              <1> 		mov		[edi + 7], ah					; „Éô„Éº„ÇπÔºà[31:24]Ôºâ
    97                              <1> 
    98                              <1> 		pop		edi
    99                              <1> 		pop		eax
   100                              <1> %endmacro
   101                              <1> 
   102                              <1> ;************************************************************************
   103                              <1> ; „Ç≤„Éº„Éà„Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË®≠ÂÆö
   104                              <1> ;
   105                              <1> ; ‰Ωø„ÅÑÊñπÔºö
   106                              <1> ;	set_gate	„Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø, „Ç™„Éï„Çª„ÉÉ„Éà
   107                              <1> ;
   108                              <1> ;************************************************************************
   109                              <1> %macro  set_gate 2-* 
   110                              <1> 		push	eax
   111                              <1> 		push	edi
   112                              <1> 
   113                              <1> 		mov		edi, %1							; „Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø„Ç¢„Éâ„É¨„Çπ
   114                              <1> 		mov		eax, %2							; „Éô„Éº„Çπ„Ç¢„Éâ„É¨„Çπ
   115                              <1> 
   116                              <1> 		mov		[edi + 0], ax					; „Éô„Éº„ÇπÔºà[15: 0]Ôºâ
   117                              <1> 		shr		eax, 16							; 
   118                              <1> 		mov		[edi + 6], ax					; „Éô„Éº„ÇπÔºà[31:16]Ôºâ
   119                              <1> 
   120                              <1> 		pop		edi
   121                              <1> 		pop		eax
   122                              <1> %endmacro
   123                              <1> 
   124                              <1> ;************************************************************************
   125                              <1> ;	ÊßãÈÄ†‰Ωì
   126                              <1> ;************************************************************************
   127                              <1> 
   128                              <1> ;-----------------------------------------------
   129                              <1> ;	„Éâ„É©„Ç§„Éñ„Éë„É©„É°„Éº„Çø
   130                              <1> ;-----------------------------------------------
   131                              <1> struc drive
   132 00000000 ????                <1> 		.no				resw	1				; „Éâ„É©„Ç§„ÉñÁï™Âè∑
   133 00000002 ????                <1> 		.cyln			resw	1				; C:„Ç∑„É™„É≥„ÉÄ
   134 00000004 ????                <1> 		.head			resw	1				; H:„Éò„ÉÉ„Éâ
   135 00000006 ????                <1> 		.sect			resw	1				; S:„Çª„ÇØ„Çø
   136                              <1> endstruc
   137                              <1> 
   138                              <1> ;-----------------------------------------------
   139                              <1> ;	„É™„É≥„Ç∞„Éê„ÉÉ„Éï„Ç°
   140                              <1> ;-----------------------------------------------
   141                              <1> %define		RING_ITEM_SIZE		(1 << 4)
   142                              <1> %define		RING_INDEX_MASK		(RING_ITEM_SIZE - 1)
   143                              <1> 
   144                              <1> struc ring_buff
   145 00000000 ????????            <1> 		.rp				resd	1				; RP:Êõ∏„ÅçËæº„Åø‰ΩçÁΩÆ
   146 00000004 ????????            <1> 		.wp				resd	1				; WP:Ë™≠„ÅøËæº„Åø‰ΩçÁΩÆ
   147 00000008 <res 10h>           <1> 		.item			resb	RING_ITEM_SIZE	; „Éê„ÉÉ„Éï„Ç°
   148                              <1> endstruc
   149                              <1> 
   150                              <1> ;-----------------------------------------------
   151                              <1> ;	„Éê„É©Êõ≤Á∑öÊèèÁîª„Éë„É©„É°„Éº„Çø
   152                              <1> ;-----------------------------------------------
   153                              <1> struc rose
   154 00000000 ????????            <1> 		.x0				resd	1				; Â∑¶‰∏äÂ∫ßÊ®ôÔºöX0
   155 00000004 ????????            <1> 		.y0				resd	1				; Â∑¶‰∏äÂ∫ßÊ®ôÔºöY0
   156 00000008 ????????            <1> 		.x1				resd	1				; Âè≥‰∏ãÂ∫ßÊ®ôÔºöX1
   157 0000000C ????????            <1> 		.y1				resd	1				; Âè≥‰∏ãÂ∫ßÊ®ôÔºöY1
   158                              <1> 
   159 00000010 ????????            <1> 		.n				resd	1				; Â§âÊï∞Ôºön
   160 00000014 ????????            <1> 		.d				resd	1				; Â§âÊï∞Ôºöd
   161                              <1> 
   162 00000018 ????????            <1> 		.color_x		resd	1				; ÊèèÁîªËâ≤ÔºöXËª∏
   163 0000001C ????????            <1> 		.color_y		resd	1				; ÊèèÁîªËâ≤ÔºöYËª∏
   164 00000020 ????????            <1> 		.color_z		resd	1				; ÊèèÁîªËâ≤ÔºöÊû†
   165 00000024 ????????            <1> 		.color_s		resd	1				; ÊèèÁîªËâ≤ÔºöÊñáÂ≠ó
   166 00000028 ????????            <1> 		.color_f		resd	1				; ÊèèÁîªËâ≤Ôºö„Ç∞„É©„ÉïÊèèÁîªËâ≤
   167 0000002C ????????            <1> 		.color_b		resd	1				; ÊèèÁîªËâ≤Ôºö„Ç∞„É©„ÉïÊ∂àÂéªËâ≤
   168                              <1> 
   169 00000030 <res 10h>           <1> 		.title			resb	16				; „Çø„Ç§„Éà„É´
   170                              <1> endstruc
   171                              <1> 
    14                                  
    15                                  		ORG		BOOT_LOAD						; ÉçÅ[ÉhÉAÉhÉåÉXÇÉAÉZÉìÉuÉâÇ…éwé¶
    16                                  
    17                                  ;************************************************************************
    18                                  ;	ÉGÉìÉgÉäÉ|ÉCÉìÉg
    19                                  ;************************************************************************
    20                                  entry:
    21                                  		;---------------------------------------
    22                                  		; BPB(BIOS Parameter Block)
    23                                  		;---------------------------------------
    24 00000000 EB58                    		jmp		ipl								; IPLÇ÷ÉWÉÉÉìÉv
    25 00000002 90<rep 58h>             		times	90 - ($ - $$) db 0x90			; 
    26                                  
    27                                  		;---------------------------------------
    28                                  		; IPL(Initial Program Loader)
    29                                  		;---------------------------------------
    30                                  ipl:
    31 0000005A FA                      		cli										; // äÑÇËçûÇ›ã÷é~
    32                                  
    33 0000005B B80000                  		mov		ax, 0x0000						; AX = 0x0000;
    34 0000005E 8ED8                    		mov		ds, ax							; DS = 0x0000;
    35 00000060 8EC0                    		mov		es, ax							; ES = 0x0000;
    36 00000062 8ED0                    		mov		ss, ax							; SS = 0x0000;
    37 00000064 BC007C                  		mov		sp, BOOT_LOAD					; SP = 0x7C00;
    38                                  
    39 00000067 FB                      		sti										; // äÑÇËçûÇ›ãñâ¬
    40                                  
    41 00000068 8816[B800]              		mov		[BOOT + drive.no], dl			; ÉuÅ[ÉgÉhÉâÉCÉuÇï€ë∂
    42                                  
    43                                  		;---------------------------------------
    44                                  		; ï∂éöóÒÇï\é¶
    45                                  		;---------------------------------------
    46 0000006C 68[9900]E84E0083C4-     		cdecl	puts, .s0						; puts(.s0);
    46 00000074 02                 
    47                                  
    48                                  		;---------------------------------------
    49                                  		; écÇËÇÃÉZÉNÉ^ÇëSÇƒì«Ç›çûÇﬁ
    50                                  		;---------------------------------------
    51 00000075 BB0F00                  		mov		bx, BOOT_SECT - 1				; BX = écÇËÇÃÉuÅ[ÉgÉZÉNÉ^êî;
    52 00000078 B9007E                  		mov		cx, BOOT_LOAD + SECT_SIZE		; CX = éüÇÃÉçÅ[ÉhÉAÉhÉåÉX;
    53                                  
    54 0000007B 515368[B800]E89B00-     		cdecl	read_chs, BOOT, bx, cx			; AX = read_chs(.chs, bx, cx);
    54 00000083 83C406             
    55                                  
    56 00000086 39D8                    		cmp		ax, bx							; if (AX != écÇËÇÃÉZÉNÉ^êî)
    57 00000088 740C                    .10Q:	jz		.10E							; {
    58 0000008A 68[A600]E8300083C4-     .10T:	cdecl	puts, .e0						;   puts(.e0);
    58 00000092 02                 
    59 00000093 E84900                  		call	reboot							;   reboot(); // çƒãNìÆ
    60                                  .10E:											; }
    61                                  
    62                                  		;---------------------------------------
    63                                  		; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
    64                                  		;---------------------------------------
    65 00000096 E9D505                  		jmp		stage_2							; ÉuÅ[ÉgèàóùÇÃëÊ2ÉXÉeÅ[ÉW
    66                                  
    67                                  		;---------------------------------------
    68                                  		; ÉfÅ[É^
    69                                  		;---------------------------------------
    70 00000099 426F6F74696E672E2E-     .s0		db	"Booting...", 0x0A, 0x0D, 0
    70 000000A2 2E0A0D00           
    71 000000A6 4572726F723A736563-     .e0		db	"Error:sector read", 0
    71 000000AF 746F72207265616400 
    72                                  
    73                                  ;************************************************************************
    74                                  ;	ÉuÅ[ÉgÉhÉâÉCÉuÇ…ä÷Ç∑ÇÈèÓïÒ
    75                                  ;************************************************************************
    76                                  ALIGN 2, db 0
    77                                  BOOT:											; ÉuÅ[ÉgÉhÉâÉCÉuÇ…ä÷Ç∑ÇÈèÓïÒ
    78                                  	istruc	drive
    79 000000B8 0000                    		at	drive.no,		dw	0				; ÉhÉâÉCÉuî‘çÜ
    80 000000BA 0000                    		at	drive.cyln,		dw	0				; C:ÉVÉäÉìÉ_
    81 000000BC 0000                    		at	drive.head,		dw	0				; H:ÉwÉbÉh
    82 000000BE 0200                    		at	drive.sect,		dw	2				; S:ÉZÉNÉ^
    83                                  	iend
    84                                  
    85                                  ;************************************************************************
    86                                  ;	ÉÇÉWÉÖÅ[Éã
    87                                  ;************************************************************************
    88                                  %include	"../modules/real/puts.s"
    89                              <1> ;************************************************************************
    90                              <1> ;	ÊñáÂ≠óÂàóË°®Á§∫
    91                              <1> ;------------------------------------------------------------------------
    92                              <1> ;	BIOS „Çí‰ΩøÁî®
    93                              <1> ;========================================================================
    94                              <1> ;‚ñ†Êõ∏Âºè		: void puts(str);
    95                              <1> ;
    96                              <1> ;‚ñ†ÂºïÊï∞
    97                              <1> ;	str		: ÊñáÂ≠óÂàó„ÅÆ„Ç¢„Éâ„É¨„Çπ
    98                              <1> ;
    99                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: ÁÑ°„Åó
   100                              <1> ;************************************************************************
   101                              <1> puts:
   102                              <1> 		;---------------------------------------
   103                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   104                              <1> 		;---------------------------------------
   105                              <1> 												; ------|--------
   106                              <1> 												;    + 4| ÊñáÂ≠óÂàó„ÅÆ„Ç¢„Éâ„É¨„Çπ
   107                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   108 000000C0 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   109 000000C1 89E5                <1> 		mov		bp, sp							; ------+--------
   110                              <1> 
   111                              <1> 		;---------------------------------------
   112                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   113                              <1> 		;---------------------------------------
   114 000000C3 50                  <1> 		push	ax
   115 000000C4 53                  <1> 		push	bx
   116 000000C5 56                  <1> 		push	si
   117                              <1> 
   118                              <1> 		;---------------------------------------
   119                              <1> 		; ÂºïÊï∞„ÇíÂèñÂæó
   120                              <1> 		;---------------------------------------
   121 000000C6 8B7604              <1> 		mov		si, [bp + 4]					; SI = ÊñáÂ≠óÂàó„ÅÆ„Ç¢„Éâ„É¨„Çπ;
   122                              <1> 
   123                              <1> 		;---------------------------------------
   124                              <1> 		; „ÄêÂá¶ÁêÜ„ÅÆÈñãÂßã„Äë
   125                              <1> 		;---------------------------------------
   126 000000C9 B40E                <1> 		mov		ah, 0x0E						; // „ÉÜ„É¨„Çø„Ç§„ÉóÂºè1ÊñáÂ≠óÂá∫Âäõ
   127 000000CB BB0000              <1> 		mov		bx, 0x0000						; // „Éö„Éº„Ç∏Áï™Âè∑„Å®ÊñáÂ≠óËâ≤„Çí0„Å´Ë®≠ÂÆö
   128 000000CE FC                  <1> 		cld										; DF = 0; // „Ç¢„Éâ„É¨„ÇπÂä†ÁÆó
   129                              <1> .10L:											; do
   130                              <1> 												; {
   131 000000CF AC                  <1> 		lodsb									;   AL = *SI++;
   132                              <1> 												;   
   133 000000D0 3C00                <1> 		cmp		al, 0							;   if (0 == AL)
   134 000000D2 7404                <1> 		je		.10E							;     break;
   135                              <1> 												;   
   136 000000D4 CD10                <1> 		int		0x10							;   Int10(0x0E, AL); // ÊñáÂ≠óÂá∫Âäõ
   137 000000D6 EBF7                <1> 		jmp		.10L							;   
   138                              <1> .10E:											; } while (1);
   139                              <1> 
   140                              <1> 		;---------------------------------------
   141                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   142                              <1> 		;---------------------------------------
   143 000000D8 5E                  <1> 		pop		si
   144 000000D9 5B                  <1> 		pop		bx
   145 000000DA 58                  <1> 		pop		ax
   146                              <1> 
   147                              <1> 		;---------------------------------------
   148                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   149                              <1> 		;---------------------------------------
   150 000000DB 89EC                <1> 		mov		sp, bp
   151 000000DD 5D                  <1> 		pop		bp
   152                              <1> 
   153 000000DE C3                  <1> 		ret
   154                              <1> 
    89                                  %include	"../modules/real/reboot.s"
    90                              <1> ;************************************************************************
    91                              <1> ;	„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å¶ÂÜçËµ∑Âãï„ÇíË°å„ÅÜ
    92                              <1> ;========================================================================
    93                              <1> ;‚ñ†Êõ∏Âºè		: void reboot(void);
    94                              <1> ;
    95                              <1> ;‚ñ†ÂºïÊï∞		: ÁÑ°„Åó
    96                              <1> ;
    97                              <1> ;‚ñ†Êàª„ÇäÂÄ§;	: ÁÑ°„Åó
    98                              <1> ;************************************************************************
    99                              <1> reboot:
   100                              <1> 		;---------------------------------------
   101                              <1> 		; „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
   102                              <1> 		;---------------------------------------
   103 000000DF 68[FB00]E8DBFF83C4- <1> 		cdecl	puts, .s0						; // ÂÜçËµ∑Âãï„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
   103 000000E7 02                  <1>
   104                              <1> 
   105                              <1> 		;---------------------------------------
   106                              <1> 		; „Ç≠„ÉºÂÖ•ÂäõÂæÖ„Å°
   107                              <1> 		;---------------------------------------
   108                              <1> .10L:											; do
   109                              <1> 												; {
   110 000000E8 B410                <1> 		mov		ah, 0x10						;   // „Ç≠„ÉºÂÖ•ÂäõÂæÖ„Å°
   111 000000EA CD16                <1> 		int		0x16							;   AL = BIOS(0x16, 0x10);
   112                              <1> 												;   
   113 000000EC 3C20                <1> 		cmp		al, ' '							;   ZF = AL == ' ';
   114 000000EE 75F8                <1> 		jne		.10L							; } while (!ZF);
   115                              <1> 
   116                              <1> 		;---------------------------------------
   117                              <1> 		; ÊîπË°å„ÇíÂá∫Âäõ
   118                              <1> 		;---------------------------------------
   119 000000F0 68[1901]E8CAFF83C4- <1> 		cdecl	puts, .s1						; ÊîπË°å
   119 000000F8 02                  <1>
   120                              <1> 
   121                              <1> 		;---------------------------------------
   122                              <1> 		; ÂÜçËµ∑Âãï
   123                              <1> 		;---------------------------------------
   124 000000F9 CD19                <1> 		int		0x19							; BIOS(0x19);       // reboot();
   125                              <1> 
   126                              <1> 		;---------------------------------------
   127                              <1> 		; ÊñáÂ≠óÂàó„Éá„Éº„Çø
   128                              <1> 		;---------------------------------------
   129 000000FB 0A0D50757368205350- <1> .s0		db	0x0A, 0x0D, "Push SPACE key to reboot...", 0
   129 00000104 414345206B65792074- <1>
   129 0000010D 6F207265626F6F742E- <1>
   129 00000116 2E2E00              <1>
   130 00000119 0A0D0A0D00          <1> .s1		db	0x0A, 0x0D, 0x0A, 0x0D, 0
   131                              <1> 
    90                                  %include	"../modules/real/read_chs.s"
    91                              <1> ;************************************************************************
    92                              <1> ;	„Çª„ÇØ„ÇøË™≠„ÅøËæº„ÅøÔºàCHSÊåáÂÆöÔºâ
    93                              <1> ;------------------------------------------------------------------------
    94                              <1> ;	BIOS„Ç≥„Éº„É´ÔºàINT13 AH=0x02Ôºâ„Çí‰Ωø„Å£„Åü„Çª„ÇØ„ÇøË™≠„ÅøÂá∫„Åó
    95                              <1> ;========================================================================
    96                              <1> ;‚ñ†Êõ∏Âºè		: WORD read_chs(drive, sect, dst);
    97                              <1> ;
    98                              <1> ;‚ñ†ÂºïÊï∞
    99                              <1> ;	drive	: driveÊßãÈÄ†‰Ωì„ÅÆ„Ç¢„Éâ„É¨„Çπ
   100                              <1> ;	sect	: Ë™≠„ÅøÂá∫„Åó„Çª„ÇØ„ÇøÊï∞
   101                              <1> ;	dst		: Ë™≠„ÅøÂá∫„ÅóÂÖà„Ç¢„Éâ„É¨„Çπ
   102                              <1> ;
   103                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: Ë™≠„ÅøËæº„Çì„Å†„Çª„ÇØ„ÇøÊï∞
   104                              <1> ;************************************************************************
   105                              <1> read_chs:
   106                              <1> 		;---------------------------------------
   107                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   108                              <1> 		;---------------------------------------
   109                              <1> 												; ------|--------
   110                              <1> 												;    + 8| „Ç≥„Éî„ÉºÂÖà
   111                              <1> 												;    + 6| „Çª„ÇØ„ÇøÊï∞
   112                              <1> 												;    + 4| „Éë„É©„É°„Éº„Çø„Éê„ÉÉ„Éï„Ç°
   113                              <1> 												; ------+----------------
   114                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   115 0000011E 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   116 0000011F 89E5                <1> 		mov		bp, sp							; ------+--------
   117 00000121 6A03                <1> 		push	3								;    - 2| retry = 3; // „É™„Éà„É©„Ç§ÂõûÊï∞
   118 00000123 6A00                <1> 		push	0								;    - 4| sect  = 0; // Ë™≠„ÅøËæº„Åø„Çª„ÇØ„ÇøÊï∞
   119                              <1> 
   120                              <1> 		;---------------------------------------
   121                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   122                              <1> 		;---------------------------------------
   123 00000125 53                  <1> 		push	bx
   124 00000126 51                  <1> 		push	cx
   125 00000127 52                  <1> 		push	dx
   126 00000128 06                  <1> 		push	es
   127 00000129 56                  <1> 		push	si
   128                              <1> 
   129                              <1> 		;---------------------------------------
   130                              <1> 		; „ÄêÂá¶ÁêÜ„ÅÆÈñãÂßã„Äë
   131                              <1> 		;---------------------------------------
   132 0000012A 8B7604              <1> 		mov		si, [bp + 4]					; SI = SRC„Éê„ÉÉ„Éï„Ç°;
   133                              <1> 
   134                              <1> 		;---------------------------------------
   135                              <1> 		; CX„É¨„Ç∏„Çπ„Çø„ÅÆË®≠ÂÆö
   136                              <1> 		;ÔºàBIOS„Ç≥„Éº„É´„ÅÆÂëº„Å≥Âá∫„Åó„Å´ÈÅ©„Åó„ÅüÂΩ¢„Å´Â§âÊèõÔºâ
   137                              <1> 		;---------------------------------------
   138 0000012D 8A6C02              <1> 		mov		ch, [si + drive.cyln + 0]		; CH   = „Ç∑„É™„É≥„ÉÄÁï™Âè∑Ôºà‰∏ã‰Ωç„Éê„Ç§„ÉàÔºâ
   139 00000130 8A4C03              <1> 		mov		cl, [si + drive.cyln + 1]		; CL   = „Ç∑„É™„É≥„ÉÄÁï™Âè∑Ôºà‰∏ä‰Ωç„Éê„Ç§„ÉàÔºâ
   140 00000133 C0E106              <1> 		shl		cl, 6							; CL <<= 6; // ÊúÄ‰∏ä‰Ωç2„Éì„ÉÉ„Éà„Å´„Ç∑„Éï„Éà
   141 00000136 0A4C06              <1> 		or		cl, [si + drive.sect]			; CL  |= „Çª„ÇØ„ÇøÁï™Âè∑;
   142                              <1> 
   143                              <1> 		;---------------------------------------
   144                              <1> 		; „Çª„ÇØ„ÇøË™≠„ÅøËæº„Åø
   145                              <1> 		;---------------------------------------
   146 00000139 8A7404              <1> 		mov		dh, [si + drive.head]			; DH = „Éò„ÉÉ„ÉâÁï™Âè∑;
   147 0000013C 8A14                <1> 		mov		dl, [si + 0]					; DL = „Éâ„É©„Ç§„ÉñÁï™Âè∑;
   148 0000013E B80000              <1> 		mov		ax, 0x0000						; AX = 0x0000;
   149 00000141 8EC0                <1> 		mov		es, ax							; ES = „Çª„Ç∞„É°„É≥„Éà
   150 00000143 8B5E08              <1> 		mov		bx, [bp + 8]					; BX = „Ç≥„Éî„ÉºÂÖà;
   151                              <1> .10L:											; do
   152                              <1> 												; {
   153 00000146 B402                <1> 		mov		ah, 0x02						;   AH = „Çª„ÇØ„ÇøË™≠„ÅøËæº„Åø
   154 00000148 8A4606              <1> 		mov		al, [bp + 6]					;   AL = „Çª„ÇØ„ÇøÊï∞
   155                              <1> 												;   
   156 0000014B CD13                <1> 		int		0x13							;   CF = BIOS(0x13, 0x02);
   157 0000014D 7304                <1> 		jnc		.11E							;   if (CF)
   158                              <1> 												;   {
   159 0000014F B000                <1> 		mov		al, 0							;     AL = 0;
   160 00000151 EB0C                <1> 		jmp		.10E							;     break;
   161                              <1> .11E:											;   }
   162                              <1> 												;   
   163 00000153 3C00                <1> 		cmp		al, 0							;   if (Ë™≠„ÅøËæº„Çì„Å†„Çª„ÇØ„Çø„Åå„ÅÇ„Çå„Å∞)
   164 00000155 7508                <1> 		jne		.10E							;     break;
   165                              <1> 												;   
   166 00000157 B80000              <1> 		mov		ax, 0							;   ret = 0; // Êàª„ÇäÂÄ§„ÇíË®≠ÂÆö
   167 0000015A FF4EFE              <1> 		dec		word [bp - 2]					; }
   168 0000015D 75E7                <1> 		jnz		.10L							; while (--retry);
   169                              <1> .10E:
   170 0000015F B400                <1> 		mov		ah, 0							; AH = 0; // „Çπ„ÉÜ„Éº„Çø„ÇπÊÉÖÂ†±„ÅØÁ†¥Ê£Ñ
   171                              <1> 
   172                              <1> 		;---------------------------------------
   173                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   174                              <1> 		;---------------------------------------
   175 00000161 5E                  <1> 		pop		si
   176 00000162 07                  <1> 		pop		es
   177 00000163 5A                  <1> 		pop		dx
   178 00000164 59                  <1> 		pop		cx
   179 00000165 5B                  <1> 		pop		bx
   180                              <1> 
   181                              <1> 		;---------------------------------------
   182                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   183                              <1> 		;---------------------------------------
   184 00000166 89EC                <1> 		mov		sp, bp
   185 00000168 5D                  <1> 		pop		bp
   186                              <1> 
   187 00000169 C3                  <1> 		ret
   188                              <1> 
    91                                  
    92                                  ;************************************************************************
    93                                  ;	ÉuÅ[ÉgÉtÉâÉOÅiêÊì™512ÉoÉCÉgÇÃèIóπÅj
    94                                  ;************************************************************************
    95 0000016A 00<rep 94h>             		times	510 - ($ - $$) db 0x00
    96 000001FE 55AA                    		db	0x55, 0xAA
    97                                  
    98                                  ;************************************************************************
    99                                  ;	ÉäÉAÉãÉÇÅ[ÉhéûÇ…éÊìæÇµÇΩèÓïÒ
   100                                  ;************************************************************************
   101                                  FONT:											; ÉtÉHÉìÉg
   102 00000200 0000                    .seg:	dw	0
   103 00000202 0000                    .off:	dw	0
   104                                  ACPI_DATA:										; ACPI data
   105 00000204 00000000                .adr:	dd	0									; ACPI data address
   106 00000208 00000000                .len:	dd	0									; ACPI data length
   107                                  
   108                                  ;************************************************************************
   109                                  ;	ÉÇÉWÉÖÅ[ÉãÅiêÊì™512ÉoÉCÉgà»ç~Ç…îzíuÅj
   110                                  ;************************************************************************
   111                                  %include	"../modules/real/itoa.s"
   112                              <1> ;************************************************************************
   113                              <1> ;	Êï∞ÂÄ§„ÇíÊñáÂ≠ó„Å´Â§âÊèõ
   114                              <1> ;========================================================================
   115                              <1> ;‚ñ†Êõ∏Âºè		: void itoa(num, buff, size, radix, flags);
   116                              <1> ;
   117                              <1> ;‚ñ†ÂºïÊï∞
   118                              <1> ;	num		: Â§âÊèõ„Åô„ÇãÊï∞ÂÄ§
   119                              <1> ;	buff	: ‰øùÂ≠òÂÖà„Éê„ÉÉ„Éï„Ç°„Ç¢„Éâ„É¨„Çπ
   120                              <1> ;	size	: ‰øùÂ≠òÂÖà„Éê„ÉÉ„Éï„Ç°„Çµ„Ç§„Ç∫
   121                              <1> ;	radix	: Âü∫Êï∞Ôºà2„ÄÅ8„ÄÅ10Âèà„ÅØ16„ÇíË®≠ÂÆö„Åô„ÇãÔºâ
   122                              <1> ;	flags	: „Éï„É©„Ç∞
   123                              <1> ;			:   B2 : 1=Á©∫ÁôΩ„Çí'0'Ôºà„Çº„É≠Ôºâ„ÅßÂüã„ÇÅ„Çã
   124                              <1> ;			:      : 0=Á©∫ÁôΩ„Çí' 'Ôºà„Çπ„Éö„Éº„ÇπÔºâ„ÅßÂüã„ÇÅ„Çã
   125                              <1> ;			:   B1 : 1=Ôºã/-Á¨¶Âè∑„ÇíË°®Á§∫„Åô„Çã
   126                              <1> ;			:      : 0=Ôºã/-Á¨¶Âè∑„ÇíË°®Á§∫„Åó„Å™„ÅÑ
   127                              <1> ;			:   B0 : 1=Á¨¶Âè∑‰ªò„ÅçÊ≠£Êï∞„Å®„Åó„Å¶Êâ±„ÅÜ
   128                              <1> ;			:      : 0=Á¨¶Âè∑ÁÑ°„ÅóÊ≠£Êï∞„Å®„Åó„Å¶Êâ±„ÅÜ
   129                              <1> ;
   130                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: ÁÑ°„Åó
   131                              <1> ;************************************************************************
   132                              <1> itoa:
   133                              <1> 		;---------------------------------------
   134                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   135                              <1> 		;---------------------------------------
   136                              <1> 												; ------|--------
   137                              <1> 												;    +12| „Éï„É©„Ç∞
   138                              <1> 												;    +10| Âü∫Êï∞
   139                              <1> 												;    + 8| „Éê„ÉÉ„Éï„Ç°„Çµ„Ç§„Ç∫
   140                              <1> 												;    + 6| „Éê„ÉÉ„Éï„Ç°„Ç¢„Éâ„É¨„Çπ
   141                              <1> 												;    + 4| Êï∞ÂÄ§
   142                              <1> 												; ------|--------
   143                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   144 0000020C 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   145 0000020D 89E5                <1> 		mov		bp, sp							; ------+--------
   146                              <1> 
   147                              <1> 		;---------------------------------------
   148                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   149                              <1> 		;---------------------------------------
   150 0000020F 50                  <1> 		push	ax
   151 00000210 53                  <1> 		push	bx
   152 00000211 51                  <1> 		push	cx
   153 00000212 52                  <1> 		push	dx
   154 00000213 56                  <1> 		push	si
   155 00000214 57                  <1> 		push	di
   156                              <1> 
   157                              <1> 		;---------------------------------------
   158                              <1> 		; ÂºïÊï∞„ÇíÂèñÂæó
   159                              <1> 		;---------------------------------------
   160 00000215 8B4604              <1> 		mov		ax, [bp + 4]					; val  = Êï∞ÂÄ§;
   161 00000218 8B7606              <1> 		mov		si, [bp + 6]					; dst  = „Éê„ÉÉ„Éï„Ç°„Ç¢„Éâ„É¨„Çπ;
   162 0000021B 8B4E08              <1> 		mov		cx, [bp + 8]					; size = ÊÆã„Çä„Éê„ÉÉ„Éï„Ç°„Çµ„Ç§„Ç∫;
   163                              <1> 
   164 0000021E 89F7                <1> 		mov		di, si							; // „Éê„ÉÉ„Éï„Ç°„ÅÆÊúÄÂæåÂ∞æ
   165 00000220 01CF                <1> 		add		di, cx							; dst  = &dst[size - 1];
   166 00000222 4F                  <1> 		dec		di								; 
   167                              <1> 
   168 00000223 8B5E0C              <1> 		mov		bx, [bp +12]					; flags = „Ç™„Éó„Ç∑„Éß„É≥;
   169                              <1> 
   170                              <1> 		;---------------------------------------
   171                              <1> 		; Á¨¶Âè∑‰ªò„ÅçÂà§ÂÆö
   172                              <1> 		;---------------------------------------
   173 00000226 F7C30100            <1> 		test	bx, 0b0001						; if (flags & 0x01)// Á¨¶Âè∑‰ªò„Åç
   174 0000022A 7408                <1> .10Q:	je		.10E							; {
   175 0000022C 83F800              <1> 		cmp		ax, 0							;   if (val < 0)
   176 0000022F 7D03                <1> .12Q:	jge		.12E							;   {
   177 00000231 83CB02              <1> 		or		bx, 0b0010						;     flags |=  2; // Á¨¶Âè∑Ë°®Á§∫
   178                              <1> .12E:											;   }
   179                              <1> .10E:											; }
   180                              <1> 
   181                              <1> 		;---------------------------------------
   182                              <1> 		; Á¨¶Âè∑Âá∫ÂäõÂà§ÂÆö
   183                              <1> 		;---------------------------------------
   184 00000234 F7C30200            <1> 		test	bx, 0b0010						; if (flags & 0x02)// Á¨¶Âè∑Âá∫ÂäõÂà§ÂÆö
   185 00000238 7410                <1> .20Q:	je		.20E							; {
   186 0000023A 83F800              <1> 		cmp		ax, 0							;   if (val < 0)
   187 0000023D 7D07                <1> .22Q:	jge		.22F							;   {
   188 0000023F F7D8                <1> 		neg		ax								;     val *= -1;   // Á¨¶Âè∑ÂèçËª¢
   189 00000241 C6042D              <1> 		mov		[si], byte '-'					;     *dst = '-';  // Á¨¶Âè∑Ë°®Á§∫
   190 00000244 EB03                <1> 		jmp		.22E							;   }
   191                              <1> .22F:											;   else
   192                              <1> 												;   {
   193 00000246 C6042B              <1> 		mov		[si], byte '+'					;     *dst = '+';  // Á¨¶Âè∑Ë°®Á§∫
   194                              <1> .22E:											;   }
   195 00000249 49                  <1> 		dec		cx								;   size--;        // ÊÆã„Çä„Éê„ÉÉ„Éï„Ç°„Çµ„Ç§„Ç∫„ÅÆÊ∏õÁÆó
   196                              <1> .20E:											; }
   197                              <1> 
   198                              <1> 		;---------------------------------------
   199                              <1> 		; ASCIIÂ§âÊèõ
   200                              <1> 		;---------------------------------------
   201 0000024A 8B5E0A              <1> 		mov		bx, [bp +10]					; BX = Âü∫Êï∞;
   202                              <1> .30L:											; do
   203                              <1> 												; {
   204 0000024D BA0000              <1> 		mov		dx, 0							;   
   205 00000250 F7F3                <1> 		div		bx								;   DX = DX:AX % Âü∫Êï∞;
   206                              <1> 												;   AX = DX:AX / Âü∫Êï∞;
   207                              <1> 												;   
   208 00000252 89D6                <1> 		mov		si, dx							;   // „ÉÜ„Éº„Éñ„É´ÂèÇÁÖß
   209 00000254 8A94[7C02]          <1> 		mov		dl, byte [.ascii + si]			;   DL = ASCII[DX];
   210                              <1> 												;   
   211 00000258 8815                <1> 		mov		[di], dl						;   *dst = DL;
   212 0000025A 4F                  <1> 		dec		di								;   dst--;
   213                              <1> 												;   
   214 0000025B 83F800              <1> 		cmp		ax, 0							;   
   215 0000025E E0ED                <1> 		loopnz	.30L							; } while (AX);
   216                              <1> .30E:
   217                              <1> 
   218                              <1> 		;---------------------------------------
   219                              <1> 		; Á©∫Ê¨Ñ„ÇíÂüã„ÇÅ„Çã
   220                              <1> 		;---------------------------------------
   221 00000260 83F900              <1> 		cmp		cx, 0							; if (size)
   222 00000263 740D                <1> .40Q:	je		.40E							; {
   223 00000265 B020                <1> 		mov		al, ' '							;   AL = ' ';  // ' '„ÅßÂüã„ÇÅ„ÇãÔºà„Éá„Éï„Ç©„É´„ÉàÂÄ§Ôºâ
   224 00000267 837E0C04            <1> 		cmp		[bp +12], word 0b0100			;   if (flags & 0x04)
   225 0000026B 7502                <1> .42Q:	jne		.42E							;   {
   226 0000026D B030                <1> 		mov		al, '0'							;     AL = '0'; // '0'„ÅßÂüã„ÇÅ„Çã
   227                              <1> .42E:											;   }
   228 0000026F FD                  <1> 		std										;   // DF = 1Ôºà-ÊñπÂêëÔºâ
   229 00000270 F3AA                <1> 		rep stosb								;   while (--CX) *DI-- = ' ';
   230                              <1> .40E:											; }
   231                              <1> 
   232                              <1> 		;---------------------------------------
   233                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   234                              <1> 		;---------------------------------------
   235 00000272 5F                  <1> 		pop		di
   236 00000273 5E                  <1> 		pop		si
   237 00000274 5A                  <1> 		pop		dx
   238 00000275 59                  <1> 		pop		cx
   239 00000276 5B                  <1> 		pop		bx
   240 00000277 58                  <1> 		pop		ax
   241                              <1> 
   242                              <1> 		;---------------------------------------
   243                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   244                              <1> 		;---------------------------------------
   245 00000278 89EC                <1> 		mov		sp, bp
   246 0000027A 5D                  <1> 		pop		bp
   247                              <1> 
   248 0000027B C3                  <1> 		ret
   249                              <1> 
   250 0000027C 303132333435363738- <1> .ascii	db		"0123456789ABCDEF"				; Â§âÊèõ„ÉÜ„Éº„Éñ„É´
   250 00000285 39414243444546      <1>
   251                              <1> 
   112                                  %include	"../modules/real/get_drive_param.s"
   113                              <1> ;************************************************************************
   114                              <1> ;	„Éâ„É©„Ç§„ÉñÊÉÖÂ†±„ÅÆÂèñÂæó(LBAÂ§âÊèõ„Å´ÂøÖË¶Å„Å™ÊÉÖÂ†±)
   115                              <1> ;------------------------------------------------------------------------
   116                              <1> ;	„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å™ÊúÄÂ§ß„Çª„ÇØ„Çø„ÇídriveÊßãÈÄ†‰Ωì„Å´Ë®≠ÂÆö„Åô„Çã
   117                              <1> ;	Ê≥®Ôºâ„Éâ„É©„Ç§„ÉñÁï™Âè∑Ôºàdrive.noÔºâ„ÇíË®≠ÂÆöÂæå„Å´Âëº„Å≥Âá∫„Åô‰∫ã
   118                              <1> ;========================================================================
   119                              <1> ;‚ñ†Êõ∏Âºè		: WORD get_drive_param(drive);
   120                              <1> ;
   121                              <1> ;‚ñ†ÂºïÊï∞
   122                              <1> ;	drive	: driveÊßãÈÄ†‰Ωì„ÅÆ„Ç¢„Éâ„É¨„Çπ
   123                              <1> ;
   124                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: ÊàêÂäü(0‰ª•Â§ñ)„ÄÅÂ§±Êïó(0)
   125                              <1> ;************************************************************************
   126                              <1> get_drive_param:
   127                              <1> 		;---------------------------------------
   128                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   129                              <1> 		;---------------------------------------
   130                              <1> 												; ------|--------
   131                              <1> 												;    + 4| „Éë„É©„É°„Éº„Çø„Éê„ÉÉ„Éï„Ç°
   132                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   133 0000028C 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   134 0000028D 89E5                <1> 		mov		bp, sp							; ------+--------
   135                              <1> 
   136                              <1> 		;---------------------------------------
   137                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   138                              <1> 		;---------------------------------------
   139 0000028F 53                  <1> 		push	bx
   140 00000290 51                  <1> 		push	cx
   141 00000291 06                  <1> 		push	es
   142 00000292 56                  <1> 		push	si
   143 00000293 57                  <1> 		push	di
   144                              <1> 
   145                              <1> 		;---------------------------------------
   146                              <1> 		; „ÄêÂá¶ÁêÜ„ÅÆÈñãÂßã„Äë
   147                              <1> 		;---------------------------------------
   148 00000294 8B7604              <1> 		mov		si, [bp + 4]					; SI = „Éê„ÉÉ„Éï„Ç°
   149                              <1> 
   150 00000297 B80000              <1> 		mov		ax, 0							; Disk Base Table Pointer„ÅÆÂàùÊúüÂåñ
   151 0000029A 8EC0                <1> 		mov		es, ax							; ES = 0;
   152 0000029C 89C7                <1> 		mov		di, ax							; DI = 0;
   153                              <1> 
   154 0000029E B408                <1> 		mov		ah, 0x08						; // get drive parameters 
   155 000002A0 8A14                <1> 		mov		dl, [si + drive.no]				; DL = „Éâ„É©„Ç§„ÉñÁï™Âè∑
   156 000002A2 CD13                <1> 		int		0x13							; CF = BIOS(0x13, 0x08);
   157 000002A4 721B                <1> .10Q:	jc		.10F							; if (0 == CF)
   158                              <1> .10T:											; {
   159 000002A6 88C8                <1> 		mov		al, cl							;   AX = „Çª„ÇØ„ÇøÊï∞
   160 000002A8 83E03F              <1> 		and		ax, 0x3F						;   // ‰∏ã‰Ωç6„Éì„ÉÉ„Éà„ÅÆ„ÅøÊúâÂäπ
   161                              <1> 
   162 000002AB C0E906              <1> 		shr		cl, 6							;   CX = „Ç∑„É™„É≥„ÉÄÊï∞
   163 000002AE C1C908              <1> 		ror		cx, 8							;   
   164 000002B1 41                  <1> 		inc		cx								;   
   165                              <1> 
   166 000002B2 0FB6DE              <1> 		movzx	bx, dh							;   BX = „Éò„ÉÉ„ÉâÊï∞Ôºà1„Éô„Éº„ÇπÔºâ
   167 000002B5 43                  <1> 		inc		bx								;   
   168                              <1> 
   169 000002B6 894C02              <1> 		mov		[si + drive.cyln], cx			;   drive.syln = CX; // C:„Ç∑„É™„É≥„ÉÄÊï∞
   170 000002B9 895C04              <1> 		mov		[si + drive.head], bx			;   drive.head = BX; // H:„Éò„ÉÉ„ÉâÊï∞
   171 000002BC 894406              <1> 		mov		[si + drive.sect], ax			;   drive.sect = AX; // S:„Çª„ÇØ„ÇøÊï∞
   172                              <1> 
   173 000002BF EB03                <1> 		jmp		.10E							; }
   174                              <1> .10F:											; else
   175                              <1> 												; {
   176 000002C1 B80000              <1> 		mov		ax, 0							;   AX = 0; // Â§±Êïó
   177                              <1> .10E:											; }
   178                              <1> 
   179                              <1> 		;---------------------------------------
   180                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   181                              <1> 		;---------------------------------------
   182 000002C4 5F                  <1> 		pop		di
   183 000002C5 5E                  <1> 		pop		si
   184 000002C6 07                  <1> 		pop		es
   185 000002C7 59                  <1> 		pop		cx
   186 000002C8 5B                  <1> 		pop		bx
   187                              <1> 
   188                              <1> 		;---------------------------------------
   189                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   190                              <1> 		;---------------------------------------
   191 000002C9 89EC                <1> 		mov		sp, bp
   192 000002CB 5D                  <1> 		pop		bp
   193                              <1> 
   194 000002CC C3                  <1> 		ret
   195                              <1> 
   113                                  %include	"../modules/real/get_font_adr.s"
   114                              <1> ;************************************************************************
   115                              <1> ;	BIOS„Éï„Ç©„É≥„Éà„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
   116                              <1> ;------------------------------------------------------------------------
   117                              <1> ;	„Éï„Ç©„É≥„Éà8x16„Éâ„ÉÉ„Éà„ÅÆ„Éï„Ç©„É≥„Éà„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
   118                              <1> ;========================================================================
   119                              <1> ;‚ñ†Êõ∏Âºè		: void get_font_adr(adr);
   120                              <1> ;
   121                              <1> ;‚ñ†ÂºïÊï∞
   122                              <1> ;	adr		: „Éï„Ç©„É≥„Éà„Ç¢„Éâ„É¨„ÇπÊ†ºÁ¥ç‰ΩçÁΩÆ
   123                              <1> ;
   124                              <1> ;‚ñ†Êàª„ÇäÂÄ§;	: ÁÑ°„Åó
   125                              <1> ;************************************************************************
   126                              <1> get_font_adr:
   127                              <1> 		;---------------------------------------
   128                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   129                              <1> 		;---------------------------------------
   130                              <1> 												; ------|--------
   131                              <1> 												;    + 4| „Éë„É©„É°„Éº„Çø„Éê„ÉÉ„Éï„Ç°
   132                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   133 000002CD 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   134 000002CE 89E5                <1> 		mov		bp, sp							; ------+--------
   135                              <1> 
   136                              <1> 		;---------------------------------------
   137                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   138                              <1> 		;---------------------------------------
   139 000002D0 50                  <1> 		push	ax
   140 000002D1 53                  <1> 		push	bx
   141 000002D2 56                  <1> 		push	si
   142 000002D3 06                  <1> 		push	es
   143 000002D4 55                  <1> 		push	bp
   144                              <1> 
   145                              <1> 		;---------------------------------------
   146                              <1> 		; ÂºïÊï∞„ÇíÂèñÂæó
   147                              <1> 		;---------------------------------------
   148 000002D5 8B7604              <1> 		mov		si, [bp + 4]					; dst  =FONT„Ç¢„Éâ„É¨„Çπ„ÅÆ‰øùÂ≠òÂÖà;
   149                              <1> 
   150                              <1> 		;---------------------------------------
   151                              <1> 		; „Éï„Ç©„É≥„Éà„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó
   152                              <1> 		;---------------------------------------
   153 000002D8 B83011              <1> 		mov		ax, 0x1130						; // „Éï„Ç©„É≥„Éà„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó
   154 000002DB B706                <1> 		mov		bh, 0x06						; 8x16 font (vga/mcga) 
   155 000002DD CD10                <1> 		int		10h								; ES:BP=FONT ADDRESS
   156                              <1> 
   157                              <1> 		;---------------------------------------
   158                              <1> 		; FONT„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò
   159                              <1> 		;---------------------------------------
   160 000002DF 8C04                <1> 		mov		[si + 0], es					; dst[0] = „Çª„Ç∞„É°„É≥„Éà;
   161 000002E1 896C02              <1> 		mov		[si + 2], bp					; dst[1] = „Ç™„Éï„Çª„ÉÉ„Éà;
   162                              <1> 
   163                              <1> 		;---------------------------------------
   164                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   165                              <1> 		;---------------------------------------
   166 000002E4 5D                  <1> 		pop		bp
   167 000002E5 07                  <1> 		pop		es
   168 000002E6 5E                  <1> 		pop		si
   169 000002E7 5B                  <1> 		pop		bx
   170 000002E8 58                  <1> 		pop		ax
   171                              <1> 
   172                              <1> 		;---------------------------------------
   173                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   174                              <1> 		;---------------------------------------
   175 000002E9 89EC                <1> 		mov		sp, bp
   176 000002EB 5D                  <1> 		pop		bp
   177                              <1> 
   178 000002EC C3                  <1> 		ret
   179                              <1> 
   114                                  %include	"../modules/real/get_mem_info.s"
   115                              <1> ;************************************************************************
   116                              <1> ;	„É°„É¢„É™ÊÉÖÂ†±„ÅÆË°®Á§∫
   117                              <1> ;------------------------------------------------------------------------
   118                              <1> ;	ACPI„Éá„Éº„Çø„ÅÆ„Ç¢„Éâ„É¨„Çπ„Å®Èï∑„Åï„Çí„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠ò„Åô„Çã
   119                              <1> ;========================================================================
   120                              <1> ;‚ñ†Êõ∏Âºè		: void get_mem_info(void);
   121                              <1> ;
   122                              <1> ;‚ñ†ÂºïÊï∞		: ÁÑ°„Åó
   123                              <1> ;
   124                              <1> ;‚ñ†Êàª„ÇäÂÄ§;	: ÁÑ°„Åó
   125                              <1> ;************************************************************************
   126                              <1> get_mem_info:
   127                              <1> 		;---------------------------------------
   128                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   129                              <1> 		;---------------------------------------
   130 000002ED 6650                <1> 		push	eax
   131 000002EF 6653                <1> 		push	ebx
   132 000002F1 6651                <1> 		push	ecx
   133 000002F3 6652                <1> 		push	edx
   134 000002F5 56                  <1> 		push	si
   135 000002F6 57                  <1> 		push	di
   136 000002F7 55                  <1> 		push	bp
   137                              <1> 
   138                              <1> 		;---------------------------------------
   139                              <1> 		; „ÄêÂá¶ÁêÜ„ÅÆÈñãÂßã„Äë
   140                              <1> 		;---------------------------------------
   141 000002F8 68[8C03]E8C2FD83C4- <1> 		cdecl	puts, .s0						; // „Éò„ÉÉ„ÉÄ„ÇíË°®Á§∫
   141 00000300 02                  <1>
   142                              <1> 
   143 00000301 BD0000              <1> 		mov		bp, 0							; lines = 0; // Ë°åÊï∞
   144 00000304 66BB00000000        <1> 		mov		ebx, 0							; index = 0; // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂàùÊúüÂåñ
   145                              <1> .10L:											; do
   146                              <1> 												; {
   147 0000030A 66B820E80000        <1> 		mov		eax, 0x0000E820					;   EAX   = 0xE820
   148                              <1> 												;   EBX   = „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
   149 00000310 66B914000000        <1> 		mov		ecx, E820_RECORD_SIZE			;   ECX   = Ë¶ÅÊ±Ç„Éê„Ç§„ÉàÊï∞
   150 00000316 66BA50414D53        <1> 		mov 	edx, 'PAMS'						;   EDX   = 'SMAP';
   151 0000031C BF[1804]            <1> 		mov		di, .b0							;   ES:DI = „Éê„ÉÉ„Éï„Ç°
   152 0000031F CD15                <1> 		int		0x15							;   BIOS(0x15, 0xE820);
   153                              <1> 
   154                              <1> 		; „Ç≥„Éû„É≥„Éâ„Å´ÂØæÂøú„ÅãÔºü
   155 00000321 663D50414D53        <1> 		cmp		eax, 'PAMS'						;   if ('SMAP' != EAX)
   156 00000327 7402                <1> 		je		.12E							;   {
   157 00000329 EB4C                <1> 		jmp		.10E							;     break; // „Ç≥„Éû„É≥„ÉâÊú™ÂØæÂøú
   158                              <1> .12E:											;   }
   159                              <1> 
   160                              <1> 		; „Ç®„É©„ÉºÁÑ°„ÅóÔºü							;   if (CF)
   161 0000032B 7302                <1> 		jnc		.14E							;   {
   162 0000032D EB48                <1> 		jmp		.10E							;     break; // „Ç®„É©„ÉºÁô∫Áîü
   163                              <1> .14E:											;   }
   164                              <1> 
   165                              <1> 		; 1„É¨„Ç≥„Éº„ÉâÂàÜ„ÅÆ„É°„É¢„É™ÊÉÖÂ†±„ÇíË°®Á§∫
   166 0000032F 57E8F90083C402      <1> 		cdecl	put_mem_info, di				;   1„É¨„Ç≥„Éº„ÉâÂàÜ„ÅÆ„É°„É¢„É™ÊÉÖÂ†±„ÇíË°®Á§∫
   167                              <1> 
   168                              <1> 		; ACPI data„ÅÆ„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
   169 00000336 668B4510            <1> 		mov		eax, [di + 16]					;   EAX = „É¨„Ç≥„Éº„Éâ„Çø„Ç§„Éó;
   170 0000033A 6683F803            <1> 		cmp		eax, 3							;   if (3 == EAX) // ACPI data
   171 0000033E 750F                <1> 		jne		.15E							;   {
   172                              <1> 												;     
   173 00000340 668B05              <1> 		mov		eax, [di +  0]					;     EAX   = BASE„Ç¢„Éâ„É¨„Çπ;
   174 00000343 66A3[0402]          <1> 		mov		[ACPI_DATA.adr], eax			;     ACPI_DATA.adr = EAX;
   175                              <1> 												;     
   176 00000347 668B4508            <1> 		mov		eax, [di +  8]					;     EAX   = Length;
   177 0000034B 66A3[0802]          <1> 		mov		[ACPI_DATA.len], eax			;     ACPI_DATA.len = EAX;
   178                              <1> .15E:											;   }
   179                              <1> 
   180 0000034F 6683FB00            <1> 		cmp		ebx, 0							;   if (0 != EBX)
   181 00000353 741C                <1> 		jz		.16E							;   {
   182                              <1> 												;     
   183 00000355 45                  <1> 		inc		bp								;     lines++;
   184 00000356 83E507              <1> 		and		bp, 0x07						;     lines &= 0x07;
   185 00000359 7516                <1> 		jnz		.16E							;     if (0 == lines)
   186                              <1> 												;     {
   187 0000035B 68[FF03]E85FFD83C4- <1> 		cdecl	puts, .s2						;       // ‰∏≠Êñ≠„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
   187 00000363 02                  <1>
   188                              <1> 												;       
   189 00000364 B410                <1> 		mov		ah, 0x10						;       // „Ç≠„ÉºÂÖ•ÂäõÂæÖ„Å°
   190 00000366 CD16                <1> 		int		0x16							;       AL = BIOS(0x16, 0x10);
   191                              <1> 												;       
   192 00000368 68[0A04]E852FD83C4- <1> 		cdecl	puts, .s3						;       // ‰∏≠Êñ≠„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊ∂àÂéª
   192 00000370 02                  <1>
   193                              <1> 												;     }
   194                              <1> .16E:											;   }
   195                              <1> 												;   
   196 00000371 6683FB00            <1> 		cmp		ebx, 0							;   
   197 00000375 7593                <1> 		jne		.10L							; }
   198                              <1> .10E:											; while (0 != EBX);
   199                              <1> 
   200 00000377 68[CF03]E843FD83C4- <1> 		cdecl	puts, .s1						; // „Éï„ÉÉ„ÉÄ„ÇíË°®Á§∫
   200 0000037F 02                  <1>
   201                              <1> 
   202                              <1> 		;---------------------------------------
   203                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   204                              <1> 		;---------------------------------------
   205 00000380 5D                  <1> 		pop		bp
   206 00000381 5F                  <1> 		pop		di
   207 00000382 5E                  <1> 		pop		si
   208 00000383 665A                <1> 		pop		edx
   209 00000385 6659                <1> 		pop		ecx
   210 00000387 665B                <1> 		pop		ebx
   211 00000389 6658                <1> 		pop		eax
   212                              <1> 
   213 0000038B C3                  <1> 		ret
   214                              <1> 
   215 0000038C 2045383230204D656D- <1> .s0:	db " E820 Memory Map:", 0x0A, 0x0D
   215 00000395 6F7279204D61703A0A- <1>
   215 0000039E 0D                  <1>
   216 0000039F 20426173655F5F5F5F- <1> 		db " Base_____________ Length___________ Type____", 0x0A, 0x0D, 0
   216 000003A8 5F5F5F5F5F5F5F5F5F- <1>
   216 000003B1 204C656E6774685F5F- <1>
   216 000003BA 5F5F5F5F5F5F5F5F5F- <1>
   216 000003C3 20547970655F5F5F5F- <1>
   216 000003CC 0A0D00              <1>
   217 000003CF 202D2D2D2D2D2D2D2D- <1> .s1:	db " ----------------- ----------------- --------", 0x0A, 0x0D, 0
   217 000003D8 2D2D2D2D2D2D2D2D2D- <1>
   217 000003E1 202D2D2D2D2D2D2D2D- <1>
   217 000003EA 2D2D2D2D2D2D2D2D2D- <1>
   217 000003F3 202D2D2D2D2D2D2D2D- <1>
   217 000003FC 0A0D00              <1>
   218 000003FF 203C6D6F72652E2E2E- <1> .s2:	db " <more...>", 0
   218 00000408 3E00                <1>
   219 0000040A 0D2020202020202020- <1> .s3:	db 0x0D, "          ", 0x0D, 0
   219 00000413 20200D00            <1>
   220                              <1> 
   221 00000417 00                  <1> ALIGN 4, db 0
   222 00000418 00<rep 14h>         <1> .b0:	times E820_RECORD_SIZE db 0
   223                              <1> 
   224                              <1> ;************************************************************************
   225                              <1> ;	„É°„É¢„É™ÊÉÖÂ†±„ÅÆË°®Á§∫
   226                              <1> ;========================================================================
   227                              <1> ;‚ñ†Êõ∏Âºè		: void put_mem_info(adr);
   228                              <1> ;
   229                              <1> ;‚ñ†ÂºïÊï∞
   230                              <1> ;	adr		: „É°„É¢„É™ÊÉÖÂ†±„ÇíÂèÇÁÖß„Åô„Çã„Ç¢„Éâ„É¨„Çπ
   231                              <1> ;
   232                              <1> ;‚ñ†Êàª„ÇäÂÄ§;	: ÁÑ°„Åó
   233                              <1> ;************************************************************************
   234                              <1> put_mem_info:
   235                              <1> 		;---------------------------------------
   236                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   237                              <1> 		;---------------------------------------
   238                              <1> 												;    + 4| „Éê„ÉÉ„Éï„Ç°„Ç¢„Éâ„É¨„Çπ
   239                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   240 0000042C 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   241 0000042D 89E5                <1> 		mov		bp, sp							; ------+--------
   242                              <1> 
   243                              <1> 		;---------------------------------------
   244                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   245                              <1> 		;---------------------------------------
   246 0000042F 53                  <1> 		push	bx
   247 00000430 56                  <1> 		push	si
   248                              <1> 
   249                              <1> 		;---------------------------------------
   250                              <1> 		; ÂºïÊï∞„ÇíÂèñÂæó
   251                              <1> 		;---------------------------------------
   252 00000431 8B7604              <1> 		mov		si, [bp + 4]					; SI = „Éê„ÉÉ„Éï„Ç°„Ç¢„Éâ„É¨„Çπ;
   253                              <1> 
   254                              <1> 		;---------------------------------------
   255                              <1> 		; „É¨„Ç≥„Éº„Éâ„ÅÆË°®Á§∫
   256                              <1> 		;---------------------------------------
   257                              <1> 
   258                              <1> 		; Base(64bit)
   259 00000434 6A046A106A0468-     <1> 		cdecl	itoa, word [si + 6], .p2 + 0, 4, 16, 0b0100
   259 0000043B [0B05]FF7406E8C9FD- <1>
   259 00000443 83C40A              <1>
   260 00000446 6A046A106A0468-     <1> 		cdecl	itoa, word [si + 4], .p2 + 4, 4, 16, 0b0100
   260 0000044D [0F05]FF7404E8B7FD- <1>
   260 00000455 83C40A              <1>
   261 00000458 6A046A106A0468-     <1> 		cdecl	itoa, word [si + 2], .p3 + 0, 4, 16, 0b0100
   261 0000045F [1405]FF7402E8A5FD- <1>
   261 00000467 83C40A              <1>
   262 0000046A 6A046A106A0468-     <1> 		cdecl	itoa, word [si + 0], .p3 + 4, 4, 16, 0b0100
   262 00000471 [1805]FF34E894FD83- <1>
   262 00000479 C40A                <1>
   263                              <1> 
   264                              <1> 		; Length(64bit)
   265 0000047B 6A046A106A0468-     <1> 		cdecl	itoa, word [si +14], .p4 + 0, 4, 16, 0b0100
   265 00000482 [1D05]FF740EE882FD- <1>
   265 0000048A 83C40A              <1>
   266 0000048D 6A046A106A0468-     <1> 		cdecl	itoa, word [si +12], .p4 + 4, 4, 16, 0b0100
   266 00000494 [2105]FF740CE870FD- <1>
   266 0000049C 83C40A              <1>
   267 0000049F 6A046A106A0468-     <1> 		cdecl	itoa, word [si +10], .p5 + 0, 4, 16, 0b0100
   267 000004A6 [2605]FF740AE85EFD- <1>
   267 000004AE 83C40A              <1>
   268 000004B1 6A046A106A0468-     <1> 		cdecl	itoa, word [si + 8], .p5 + 4, 4, 16, 0b0100
   268 000004B8 [2A05]FF7408E84CFD- <1>
   268 000004C0 83C40A              <1>
   269                              <1> 
   270                              <1> 		; Type(32bit)
   271 000004C3 6A046A106A0468-     <1> 		cdecl	itoa, word [si +18], .p6 + 0, 4, 16, 0b0100
   271 000004CA [2F05]FF7412E83AFD- <1>
   271 000004D2 83C40A              <1>
   272 000004D5 6A046A106A0468-     <1> 		cdecl	itoa, word [si +16], .p6 + 4, 4, 16, 0b0100
   272 000004DC [3305]FF7410E828FD- <1>
   272 000004E4 83C40A              <1>
   273                              <1> 
   274 000004E7 68[0A05]E8D3FB83C4- <1> 		cdecl	puts, .s1						;   // „É¨„Ç≥„Éº„ÉâÊÉÖÂ†±„ÇíË°®Á§∫
   274 000004EF 02                  <1>
   275                              <1> 
   276 000004F0 8B5C10              <1> 		mov		bx, [si +16]					;   // „Çø„Ç§„Éó„ÇíÊñáÂ≠óÂàó„ÅßË°®Á§∫
   277 000004F3 83E307              <1> 		and		bx, 0x07						;   BX  = Type(0ÔΩû5)
   278 000004F6 D1E3                <1> 		shl		bx, 1							;   BX *= 2;   // Ë¶ÅÁ¥†„Çµ„Ç§„Ç∫„Å´Â§âÊèõ
   279 000004F8 81C3[8C05]          <1> 		add		bx, .t0							;   BX += .t0; // „ÉÜ„Éº„Éñ„É´„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ„ÇíÂä†ÁÆó
   280 000004FC FF37E8BFFB83C402    <1> 		cdecl	puts, word [bx]					;   puts(*BX);
   281                              <1> 
   282                              <1> 		;---------------------------------------
   283                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   284                              <1> 		;---------------------------------------
   285 00000504 5E                  <1> 		pop		si
   286 00000505 5B                  <1> 		pop		bx
   287                              <1> 
   288                              <1> 		;---------------------------------------
   289                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   290                              <1> 		;---------------------------------------
   291 00000506 89EC                <1> 		mov		sp, bp
   292 00000508 5D                  <1> 		pop		bp
   293                              <1> 
   294 00000509 C3                  <1> 		ret;
   295                              <1> 
   296 0000050A 20                  <1> .s1:	db " "
   297 0000050B 5A5A5A5A5A5A5A5A5F  <1> .p2:	db "ZZZZZZZZ_"
   298 00000514 5A5A5A5A5A5A5A5A20  <1> .p3:	db "ZZZZZZZZ "
   299 0000051D 5A5A5A5A5A5A5A5A5F  <1> .p4:	db "ZZZZZZZZ_"
   300 00000526 5A5A5A5A5A5A5A5A20  <1> .p5:	db "ZZZZZZZZ "
   301 0000052F 5A5A5A5A5A5A5A5A00  <1> .p6:	db "ZZZZZZZZ", 0
   302                              <1> 
   303 00000538 2028556E6B6E6F776E- <1> .s4:	db " (Unknown)", 0x0A, 0x0D, 0
   303 00000541 290A0D00            <1>
   304 00000545 2028757361626C6529- <1> .s5:	db " (usable)", 0x0A, 0x0D, 0
   304 0000054E 0A0D00              <1>
   305 00000551 202872657365727665- <1> .s6:	db " (reserved)", 0x0A, 0x0D, 0
   305 0000055A 64290A0D00          <1>
   306 0000055F 202841435049206461- <1> .s7:	db " (ACPI data)", 0x0A, 0x0D, 0
   306 00000568 7461290A0D00        <1>
   307 0000056E 202841435049204E56- <1> .s8:	db " (ACPI NVS)", 0x0A, 0x0D, 0
   307 00000577 53290A0D00          <1>
   308 0000057C 2028626164206D656D- <1> .s9:	db " (bad memory)", 0x0A, 0x0D, 0
   308 00000585 6F7279290A0D00      <1>
   309                              <1> 
   310 0000058C [3805][4505][5105]- <1> .t0:	dw .s4, .s5, .s6, .s7, .s8, .s9, .s4, .s4
   310 00000592 [5F05][6E05][7C05]- <1>
   310 00000598 [3805][3805]        <1>
   311                              <1> 
   115                                  %include	"../modules/real/kbc.s"
   116                              <1> ;************************************************************************
   117                              <1> ;	KBC„ÅÆÂá∫Âäõ„Éê„ÉÉ„Éï„Ç°„Å´Êõ∏„ÅçËæº„ÇÄ
   118                              <1> ;========================================================================
   119                              <1> ;‚ñ†Êõ∏Âºè		: WORD KBC_Data_Write(data);
   120                              <1> ;
   121                              <1> ;‚ñ†ÂºïÊï∞
   122                              <1> ;	data	: Êõ∏„ÅçËæº„Åø„Éá„Éº„Çø
   123                              <1> ;
   124                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: ÊàêÂäü(0‰ª•Â§ñ)„ÄÅÂ§±Êïó(0)
   125                              <1> ;************************************************************************
   126                              <1> KBC_Data_Write:
   127                              <1>                 ;---------------------------------------
   128                              <1>                 ; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   129                              <1>                 ;---------------------------------------
   130                              <1>                                                         
   131                              <1>                                                         ;    + 4| „Éá„Éº„Çø
   132                              <1>                                                         ;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   133 0000059C 55                  <1>                 push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   134 0000059D 89E5                <1>                 mov		bp, sp							; ------+--------
   135                              <1> 
   136                              <1>                 ;---------------------------------------
   137                              <1>                 ; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   138                              <1>                 ;---------------------------------------
   139 0000059F 51                  <1>                 push	cx
   140                              <1> 
   141                              <1>                 ;---------------------------------------
   142                              <1>                 ; „Éá„Éº„ÇøÊõ∏„ÅçËæº„Åø
   143                              <1>                 ;---------------------------------------
   144 000005A0 B90000              <1>                 mov		cx, 0							; CX = 0; // ÊúÄÂ§ß„Ç´„Ç¶„É≥„ÉàÂÄ§
   145                              <1>         .10L:											; do
   146                              <1>                                                         ; {
   147 000005A3 E464                <1>                 in		al, 0x64						;   AL = inp(0x64); // KBC„Çπ„ÉÜ„Éº„Çø„Çπ
   148 000005A5 A802                <1>                 test    al, 0x02						;   ZF = AL & 0x02; // Êõ∏„ÅçËæº„ÅøÂèØËÉΩÔºü
   149 000005A7 E0FA                <1>                 loopnz	.10L							; } while (--CX && !ZF);
   150                              <1>                                                         ; 
   151 000005A9 83F900              <1>                 cmp		cx, 0							; if (CX) // Êú™„Çø„Ç§„É†„Ç¢„Ç¶„Éà
   152 000005AC 7405                <1>                 jz		.20E							; {
   153                              <1>                                                         ;   
   154 000005AE 8A4604              <1>                 mov		al, [bp + 4]					;   AL = „Éá„Éº„Çø;
   155 000005B1 E660                <1>                 out    	0x60, al						;   outp(0x60, AL);
   156                              <1>         .20E:											; }
   157                              <1>                                                         ; 
   158 000005B3 89C8                <1>                 mov		ax, cx							; return CX;
   159                              <1> 
   160                              <1>                 ;---------------------------------------
   161                              <1>                 ; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   162                              <1>                 ;---------------------------------------
   163 000005B5 59                  <1>                 pop		cx
   164                              <1> 
   165                              <1>                 ;---------------------------------------
   166                              <1>                 ; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   167                              <1>                 ;---------------------------------------
   168 000005B6 89EC                <1>                 mov		sp, bp
   169 000005B8 5D                  <1>                 pop		bp
   170                              <1> 
   171 000005B9 C3                  <1>                 ret
   172                              <1> 
   173                              <1> 
   174                              <1> ;************************************************************************
   175                              <1> ;	KBC„ÅÆÂá∫Âäõ„Éê„ÉÉ„Éï„Ç°„ÇíË™≠„ÅøËæº„ÇÄ
   176                              <1> ;========================================================================
   177                              <1> ;‚ñ†Êõ∏Âºè		: WORD KBC_Data_Read(data);
   178                              <1> ;
   179                              <1> ;‚ñ†ÂºïÊï∞
   180                              <1> ;	data	: Ë™≠„ÅøËæº„Åø„Éá„Éº„ÇøÊ†ºÁ¥ç„Ç¢„Éâ„É¨„Çπ
   181                              <1> ;
   182                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: ÊàêÂäü(0‰ª•Â§ñ)„ÄÅÂ§±Êïó(0)
   183                              <1> ;************************************************************************
   184                              <1> KBC_Data_Read:
   185                              <1> 
   186                              <1>                 ;---------------------------------------
   187                              <1>                 ; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   188                              <1>                 ;---------------------------------------
   189                              <1>                                                         ;    + 4| Ê†ºÁ¥ç„Ç¢„Éâ„É¨„Çπ
   190                              <1>                                                         ;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   191 000005BA 55                  <1>                 push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   192 000005BB 89E5                <1>                 mov		bp, sp							; ------+--------
   193                              <1> 
   194                              <1>                 ;---------------------------------------
   195                              <1>                 ; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   196                              <1>                 ;---------------------------------------
   197 000005BD 51                  <1>                 push	cx
   198 000005BE 57                  <1>                 push	di
   199                              <1> 
   200                              <1>                 ;---------------------------------------
   201                              <1>                 ; „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
   202                              <1>                 ;---------------------------------------
   203 000005BF B90000              <1>                 mov		cx, 0							; CX = 0; // ÊúÄÂ§ß„Ç´„Ç¶„É≥„ÉàÂÄ§
   204                              <1>         .10L:											; do
   205                              <1>                                                         ; {
   206 000005C2 E464                <1>                 in		al, 0x64						;   AL = inp(0x64); // KBC„Çπ„ÉÜ„Éº„Çø„Çπ
   207 000005C4 A801                <1>                 test    al, 0x01						;   ZF = AL & 0x01; // Ë™≠„ÅøËæº„ÅøÂèØËÉΩÔºü
   208 000005C6 E1FA                <1>                 loopz	.10L							; } while (--CX && ZF);
   209                              <1>                                                         ;   
   210 000005C8 83F900              <1>                 cmp		cx, 0							; if (CX) // Êú™„Çø„Ç§„É†„Ç¢„Ç¶„Éà
   211 000005CB 7409                <1>                 jz		.20E							; {
   212                              <1>                                                         ;   
   213 000005CD B400                <1>                 mov		ah, 0x00						;   AH = 0x00;
   214 000005CF E460                <1>                 in     	al, 0x60						;   AL = inp(0x60); // „Éá„Éº„ÇøÂèñÂæó
   215                              <1>                                                         ;   
   216 000005D1 8B7E04              <1>                 mov		di, [bp + 4]					;   DI    = adr;
   217 000005D4 8905                <1>                 mov		[di + 0], ax					;   DI[0] = AX;
   218                              <1>         .20E:											; }
   219                              <1>                                                         ; 
   220 000005D6 89C8                <1>                 mov		ax, cx		                    ;  return CX;
   221                              <1> 
   222                              <1>                 ;---------------------------------------
   223                              <1>                 ; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   224                              <1>                 ;---------------------------------------
   225 000005D8 5F                  <1>                 pop		di
   226 000005D9 59                  <1>                 pop		cx
   227                              <1> 
   228                              <1>                 ;---------------------------------------
   229                              <1>                 ; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   230                              <1>                 ;---------------------------------------
   231 000005DA 89EC                <1>                 mov		sp, bp
   232 000005DC 5D                  <1>                 pop		bp
   233                              <1> 
   234 000005DD C3                  <1>                 ret
   235                              <1> 
   236                              <1> 
   237                              <1> ;************************************************************************
   238                              <1> ;	KBC„Å´„Ç≥„Éû„É≥„Éâ„ÇíÂá∫Âäõ
   239                              <1> ;========================================================================
   240                              <1> ;‚ñ†Êõ∏Âºè		: WORD KBC_Cmd_Write(cmd);
   241                              <1> ;
   242                              <1> ;‚ñ†ÂºïÊï∞
   243                              <1> ;	cmd		: „Ç≥„Éû„É≥„Éâ
   244                              <1> ;
   245                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: ÊàêÂäü(0‰ª•Â§ñ)„ÄÅÂ§±Êïó(0)
   246                              <1> ;************************************************************************
   247                              <1> KBC_Cmd_Write:
   248                              <1>                 ;---------------------------------------
   249                              <1>                 ; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   250                              <1>                 ;---------------------------------------
   251                              <1>                                                         ;    + 4| „Ç≥„Éû„É≥„Éâ
   252                              <1>                                                         ;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   253 000005DE 55                  <1>                 push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   254 000005DF 89E5                <1>                 mov		bp, sp							; ------+--------
   255                              <1> 
   256                              <1>                 ;---------------------------------------
   257                              <1>                 ; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   258                              <1>                 ;---------------------------------------
   259 000005E1 51                  <1>                 push	cx
   260                              <1> 
   261                              <1>                 ;---------------------------------------
   262                              <1>                 ; „Ç≥„Éû„É≥„ÉâÊõ∏„ÅçËæº„Åø
   263                              <1>                 ;---------------------------------------
   264 000005E2 B90000              <1>                 mov		cx, 0							; CX = 0; // ÊúÄÂ§ß„Ç´„Ç¶„É≥„ÉàÂÄ§
   265                              <1>         .10L:											; do
   266                              <1>                                                         ; {
   267 000005E5 E464                <1>                 in		al, 0x64						;   AL = inp(0x64); // KBC„Çπ„ÉÜ„Éº„Çø„Çπ
   268 000005E7 A802                <1>                 test    al, 0x02						;   ZF = AL & 0x02; // Êõ∏„ÅçËæº„ÅøÂèØËÉΩÔºü
   269 000005E9 E0FA                <1>                 loopnz	.10L							; } while (--CX && !ZF);
   270                              <1>                                                         ; 
   271 000005EB 83F900              <1>                 cmp		cx, 0							; if (CX) // Êú™„Çø„Ç§„É†„Ç¢„Ç¶„Éà
   272 000005EE 7405                <1>                 jz		.20E							; {
   273                              <1>                                                         ;   
   274 000005F0 8A4604              <1>                 mov		al, [bp + 4]					;   AL = „Ç≥„Éû„É≥„Éâ;
   275 000005F3 E664                <1>                 out    	0x64, al						;   outp(0x64, AL);
   276                              <1>         .20E:											; }
   277                              <1> 
   278 000005F5 89C8                <1>                 mov		ax, cx							; return CX;
   279                              <1> 
   280                              <1>                 ;---------------------------------------
   281                              <1>                 ; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   282                              <1>                 ;---------------------------------------
   283 000005F7 59                  <1>                 pop		cx
   284                              <1> 
   285                              <1>                 ;---------------------------------------
   286                              <1>                 ; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   287                              <1>                 ;---------------------------------------
   288 000005F8 89EC                <1>                 mov		sp, bp
   289 000005FA 5D                  <1>                 pop		bp
   290                              <1> 
   291 000005FB C3                  <1>                 ret
   116                                  %include	"../modules/real/lba_chs.s"
   117                              <1> ;************************************************************************
   118                              <1> ;	LBA„ÇíCHS„Å´Â§âÊèõ
   119                              <1> ;------------------------------------------------------------------------
   120                              <1> ;	‰∫ãÂâç„Å´„Éá„Éê„Ç§„Çπ„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„Åä„Åè
   121                              <1> ;========================================================================
   122                              <1> ;‚ñ†Êõ∏Âºè		: void lba_chs(drive, drv_chs, lba);
   123                              <1> ;
   124                              <1> ;‚ñ†ÂºïÊï∞
   125                              <1> ;	drive	: driveÊßãÈÄ†‰Ωì„ÅÆ„Ç¢„Éâ„É¨„Çπ
   126                              <1> ;			:Ôºà„Éâ„É©„Ç§„Éñ„Éë„É©„É°„Éº„Çø„ÅåÊ†ºÁ¥ç„Åï„Çå„Å¶„ÅÑ„ÇãÔºâ
   127                              <1> ;	drv_chs	: driveÊßãÈÄ†‰Ωì„ÅÆ„Ç¢„Éâ„É¨„Çπ
   128                              <1> ;			:ÔºàÂ§âÊèõÂæå„ÅÆ„Ç∑„É™„É≥„ÉÄÁï™Âè∑„ÄÅ„Éò„ÉÉ„ÉâÁï™Âè∑„Åù„Åó„Å¶„Çª„ÇØ„ÇøÁï™Âè∑„Çí‰øùÂ≠ò„Åô„ÇãÔºâ
   129                              <1> ;	lba		: LBA
   130                              <1> ;
   131                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: ÊàêÂäü(0‰ª•Â§ñ)„ÄÅÂ§±Êïó(0)
   132                              <1> ;************************************************************************
   133                              <1> lba_chs:
   134                              <1> 		;---------------------------------------
   135                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   136                              <1> 		;---------------------------------------
   137                              <1> 												; ------|--------
   138                              <1> 												;    + 8| LBAÔºà2„Éê„Ç§„ÉàÔºâ
   139                              <1> 												;    + 6| drv_chs„Éâ„É©„Ç§„ÉñÊÉÖÂ†±
   140                              <1> 												;    + 4| drive„Éâ„É©„Ç§„ÉñÊÉÖÂ†±
   141                              <1> 												; ------+--------
   142                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   143 000005FC 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   144 000005FD 89E5                <1> 		mov		bp, sp							; ------+--------
   145                              <1> 
   146                              <1> 		;---------------------------------------
   147                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   148                              <1> 		;---------------------------------------
   149 000005FF 50                  <1> 		push	ax
   150 00000600 53                  <1> 		push	bx
   151 00000601 52                  <1> 		push	dx
   152 00000602 56                  <1> 		push	si
   153 00000603 57                  <1> 		push	di
   154                              <1> 
   155                              <1>         ;---------------------------------------
   156                              <1> 		; „ÄêÂá¶ÁêÜ„ÅÆÈñãÂßã„Äë
   157                              <1> 		;---------------------------------------
   158 00000604 8B7604              <1> 		mov		si, [bp + 4]					; SI  = drive„Éê„ÉÉ„Éï„Ç°;
   159 00000607 8B7E06              <1> 		mov		di, [bp + 6]					; DI  = drv_chs„Éê„ÉÉ„Éï„Ç°;
   160                              <1> 
   161                              <1> 		; „Ç∑„É™„É≥„ÉÄ„ÅÇ„Åü„Çä„ÅÆ„Çª„ÇØ„ÇøÊï∞„ÇíË®àÁÆóÔºà„Éò„ÉÉ„ÉâÊï∞√ó„Çª„ÇØ„ÇøÊï∞Ôºâ
   162 0000060A 8A4404              <1> 		mov		al,  [si + drive.head]			; AL = ÊúÄÂ§ß„Éò„ÉÉ„ÉâÊï∞;
   163 0000060D F66406              <1> 		mul		byte [si + drive.sect]			; AX = ÊúÄÂ§ß„Éò„ÉÉ„ÉâÊï∞ * ÊúÄÂ§ß„Çª„ÇØ„ÇøÊï∞;
   164 00000610 89C3                <1> 		mov		bx, ax							; BX = „Ç∑„É™„É≥„ÉÄ„ÅÇ„Åü„Çä„ÅÆ„Çª„ÇØ„ÇøÊï∞;
   165                              <1> 
   166                              <1> 		; „Ç∑„É™„É≥„ÉÄÁï™Âè∑„ÇíÂèñÂæó„Åô„Çã„Åü„ÇÅ„Å´
   167                              <1> 		; LBA„Çí„Ç∑„É™„É≥„ÉÄ„ÅÇ„Åü„Çä„ÅÆ„Çª„ÇØ„ÇøÊï∞„ÅßÈô§ÁÆó
   168 00000612 BA0000              <1> 		mov		dx, 0							; DX = LBAÔºà‰∏ä‰Ωç2„Éê„Ç§„ÉàÔºâ
   169 00000615 8B4608              <1> 		mov		ax,  [bp + 8]					; AX = LBAÔºà‰∏ã‰Ωç2„Éê„Ç§„ÉàÔºâ
   170 00000618 F7F3                <1> 		div		bx								; DX = DX:AX % BX; // ÊÆã„Çä
   171                              <1> 												; AX = DX:AX / BX; // „Ç∑„É™„É≥„ÉÄÁï™Âè∑
   172                              <1> 
   173 0000061A 894502              <1> 		mov		[di + drive.cyln], ax			; drv_chs.cyln = „Ç∑„É™„É≥„ÉÄÁï™Âè∑;
   174                              <1> 
   175                              <1> 		; „Éò„ÉÉ„Éâ‰ΩçÁΩÆ„ÇíÂèñÂæó„Åô„Çã„Åü„ÇÅ„Å´
   176                              <1> 		; „ÅÇ„Åæ„Çä„Çí„Éà„É©„ÉÉ„ÇØ„ÅÇ„Åü„Çä„ÅÆ„Çª„ÇØ„ÇøÊï∞„ÅßÈô§ÁÆó
   177 0000061D 89D0                <1> 		mov		ax, dx							; AX = ÊÆã„Çä
   178 0000061F F67406              <1> 		div		byte [si + drive.sect]			; AH = AX % ÊúÄÂ§ß„Çª„ÇØ„ÇøÊï∞; // „Çª„ÇØ„ÇøÁï™Âè∑
   179                              <1> 												; AL = AX / ÊúÄÂ§ß„Çª„ÇØ„ÇøÊï∞; // „Éò„ÉÉ„ÉâÁï™Âè∑
   180                              <1> 
   181 00000622 0FB6D4              <1> 		movzx	dx, ah							; DX = „Çª„ÇØ„ÇøÁï™Âè∑
   182 00000625 42                  <1> 		inc		dx								; Ôºà„Çª„ÇØ„Çø„ÅØ1Âßã„Åæ„Çä„Å™„ÅÆ„Åß+1Ôºâ
   183                              <1> 
   184 00000626 B400                <1> 		mov		ah, 0x00						; AX = „Éò„ÉÉ„Éâ‰ΩçÁΩÆ
   185                              <1> 
   186 00000628 894504              <1> 		mov		[di + drive.head], ax			; drv_chs.head = „Éò„ÉÉ„ÉâÁï™Âè∑;
   187 0000062B 895506              <1> 		mov		[di + drive.sect], dx			; drv_chs.sect = „Çª„ÇØ„ÇøÁï™Âè∑;
   188                              <1> 
   189                              <1> 		;---------------------------------------
   190                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   191                              <1> 		;---------------------------------------
   192 0000062E 5F                  <1> 		pop		di
   193 0000062F 5E                  <1> 		pop		si
   194 00000630 5A                  <1> 		pop		dx
   195 00000631 5B                  <1> 		pop		bx
   196 00000632 58                  <1> 		pop		ax
   197                              <1> 
   198                              <1> 		;---------------------------------------
   199                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   200                              <1> 		;---------------------------------------
   201 00000633 89EC                <1> 		mov		sp, bp
   202 00000635 5D                  <1> 		pop		bp
   203                              <1> 
   204 00000636 C3                  <1> 		ret
   205                              <1> 
   117                                  %include	"../modules/real/read_lba.s"
   118                              <1> ;************************************************************************
   119                              <1> ;	„Çª„ÇØ„ÇøË™≠„ÅøËæº„Åø(LBAÊåáÂÆö)
   120                              <1> ;------------------------------------------------------------------------
   121                              <1> ;	‰∫ãÂâç„Å´„Éâ„É©„Ç§„Éñ„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„Åä„Åè
   122                              <1> ;========================================================================
   123                              <1> ;‚ñ†Êõ∏Âºè		: WORD read_lba(drive, lba, sect, dst);
   124                              <1> ;
   125                              <1> ;‚ñ†ÂºïÊï∞
   126                              <1> ;	drive	: driveÊßãÈÄ†‰Ωì„ÅÆ„Ç¢„Éâ„É¨„Çπ
   127                              <1> ;			:Ôºà„Éâ„É©„Ç§„Éñ„Éë„É©„É°„Éº„Çø„ÅåÊ†ºÁ¥ç„Åï„Çå„Å¶„ÅÑ„ÇãÔºâ
   128                              <1> ;	lba		: LBA
   129                              <1> ;	sect	: Ë™≠„ÅøÂá∫„Åó„Çª„ÇØ„ÇøÊï∞
   130                              <1> ;	dst		: Ë™≠„ÅøÂá∫„ÅóÂÖà„Ç¢„Éâ„É¨„Çπ
   131                              <1> ;
   132                              <1> ;‚ñ†Êàª„ÇäÂÄ§	: Ë™≠„ÅøËæº„Çì„Å†„Çª„ÇØ„ÇøÊï∞
   133                              <1> ;************************************************************************
   134                              <1> read_lba:
   135                              <1> 		;---------------------------------------
   136                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ„Äë
   137                              <1> 		;---------------------------------------
   138                              <1> 												; ------|--------
   139                              <1> 												;    +10| „Ç≥„Éî„ÉºÂÖà
   140                              <1> 												;    + 8| „Çª„ÇØ„ÇøÊï∞
   141                              <1> 												;    + 6| LBAÔºà2„Éê„Ç§„ÉàÔºâ
   142                              <1> 												;    + 4| „Éâ„É©„Ç§„ÉñÊÉÖÂ†±
   143                              <1> 												; ------+--------
   144                              <1> 												;    + 2| IPÔºàÊàª„ÇäÁï™Âú∞Ôºâ
   145 00000637 55                  <1> 		push	bp								;  BP+ 0| BPÔºàÂÖÉ„ÅÆÂÄ§Ôºâ
   146 00000638 89E5                <1> 		mov		bp, sp							; ------+--------
   147                              <1> 
   148                              <1>         ;---------------------------------------
   149                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò„Äë
   150                              <1> 		;---------------------------------------
   151 0000063A 56                  <1> 		push	si
   152                              <1> 
   153                              <1> 		;---------------------------------------
   154                              <1> 		; „ÄêÂá¶ÁêÜ„ÅÆÈñãÂßã„Äë
   155                              <1> 		;---------------------------------------
   156 0000063B 8B7604              <1> 		mov		si, [bp + 4]					; SI = „Éâ„É©„Ç§„ÉñÊÉÖÂ†±;
   157                              <1> 
   158                              <1> 		;---------------------------------------
   159                              <1> 		; LBA‚ÜíCHSÂ§âÊèõ
   160                              <1> 		;---------------------------------------
   161 0000063E 8B4606              <1> 		mov		ax, [bp + 6]					; AX = LBA;
   162 00000641 5068[6606]56E8B3FF- <1> 		cdecl	lba_chs, si, .chs, ax			; lba_chs(drive, .chs, AX);
   162 00000649 83C406              <1>
   163                              <1> 
   164                              <1> 		;---------------------------------------
   165                              <1> 		; „Éâ„É©„Ç§„ÉñÁï™Âè∑„ÅÆ„Ç≥„Éî„Éº
   166                              <1> 		;---------------------------------------
   167 0000064C 8A04                <1> 		mov		al, [si + drive.no]				; 
   168 0000064E A2[6606]            <1> 		mov		[.chs + drive.no], al			; „Éâ„É©„Ç§„ÉñÁï™Âè∑
   169                              <1> 
   170                              <1> 		;---------------------------------------
   171                              <1> 		; „Çª„ÇØ„Çø„ÅÆË™≠„ÅøËæº„Åø
   172                              <1> 		;---------------------------------------
   173 00000651 FF760AFF760868-     <1> 		cdecl	read_chs, .chs, word [bp + 8], word [bp +10]
   173 00000658 [6606]E8C1FA83C406  <1>
   174                              <1> 												; AX = read_chs(.chs, „Çª„ÇØ„ÇøÊï∞, ofs);
   175                              <1> 
   176                              <1> 		;---------------------------------------
   177                              <1> 		; „Äê„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞„Äë
   178                              <1> 		;---------------------------------------
   179 00000660 5E                  <1> 		pop		si
   180                              <1> 
   181                              <1> 		;---------------------------------------
   182                              <1> 		; „Äê„Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ„Äë
   183                              <1> 		;---------------------------------------
   184 00000661 89EC                <1> 		mov		sp, bp
   185 00000663 5D                  <1> 		pop		bp
   186                              <1> 
   187 00000664 C3                  <1> 		ret
   188                              <1> 
   189 00000665 90                  <1> ALIGN 2
   190 00000666 00<rep 8h>          <1> .chs:	times drive_size	db	0				; Ë™≠„ÅøËæº„Åø„Çª„ÇØ„Çø„Å´Èñ¢„Åô„ÇãÊÉÖÂ†±
   118                                  
   119                                  ;************************************************************************
   120                                  ;	ÉuÅ[ÉgèàóùÇÃëÊ2ÉXÉeÅ[ÉW
   121                                  ;************************************************************************
   122                                  stage_2:
   123                                  		;---------------------------------------
   124                                  		; ï∂éöóÒÇï\é¶
   125                                  		;---------------------------------------
   126 0000066E 68[E806]E84CFA83C4-     		cdecl	puts, .s0						; puts(.s0);
   126 00000676 02                 
   127                                  
   128                                  		;---------------------------------------
   129                                  		; ÉhÉâÉCÉuèÓïÒÇéÊìæ
   130                                  		;---------------------------------------
   131 00000677 68[B800]E80FFC83C4-     		cdecl	get_drive_param, BOOT			; get_drive_param(DX, BOOT.CYLN);
   131 0000067F 02                 
   132 00000680 83F800                  		cmp		ax, 0							; if (0 == AX)
   133 00000683 750C                    .10Q:	jne		.10E							; {
   134 00000685 68[1F07]E835FA83C4-     .10T:	cdecl	puts, .e0						;   puts(.e0);
   134 0000068D 02                 
   135 0000068E E84EFA                  		call	reboot							;   reboot(); // çƒãNìÆ
   136                                  .10E:											; }
   137                                  
   138                                  		;---------------------------------------
   139                                  		; ÉhÉâÉCÉuèÓïÒÇï\é¶
   140                                  		;---------------------------------------
   141 00000691 A1[B800]                		mov		ax, [BOOT + drive.no]			; AX = ÉuÅ[ÉgÉhÉâÉCÉu;
   142 00000694 6A046A106A0268-         		cdecl	itoa, ax, .p1, 2, 16, 0b0100	; 
   142 0000069B [0007]50E86BFB83C4-
   142 000006A3 0A                 
   143 000006A4 A1[BA00]                		mov		ax, [BOOT + drive.cyln]			; 
   144 000006A7 6A046A106A0468-         		cdecl	itoa, ax, .p2, 4, 16, 0b0100	; 
   144 000006AE [0807]50E858FB83C4-
   144 000006B6 0A                 
   145 000006B7 A1[BC00]                		mov		ax, [BOOT + drive.head]			; AX = ÉwÉbÉhêî;
   146 000006BA 6A046A106A0268-         		cdecl	itoa, ax, .p3, 2, 16, 0b0100	; 
   146 000006C1 [1207]50E845FB83C4-
   146 000006C9 0A                 
   147 000006CA A1[BE00]                		mov		ax, [BOOT + drive.sect]			; AX = ÉgÉâÉbÉNÇ†ÇΩÇËÇÃÉZÉNÉ^êî;
   148 000006CD 6A046A106A0268-         		cdecl	itoa, ax, .p4, 2, 16, 0b0100	; 
   148 000006D4 [1A07]50E832FB83C4-
   148 000006DC 0A                 
   149 000006DD 68[F706]E8DDF983C4-     		cdecl	puts, .s1
   149 000006E5 02                 
   150                                  
   151                                  		;---------------------------------------
   152                                  		; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   153                                  		;---------------------------------------
   154 000006E6 EB52                    		jmp		stage_3rd						; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   155                                  
   156                                  		;---------------------------------------
   157                                  		; ÉfÅ[É^
   158                                  		;---------------------------------------
   159 000006E8 326E64207374616765-     .s0		db	"2nd stage...", 0x0A, 0x0D, 0
   159 000006F1 2E2E2E0A0D00       
   160                                  
   161 000006F7 2044726976653A3078      .s1		db	" Drive:0x"
   162 00000700 20202C20433A3078        .p1		db	"  , C:0x"
   163 00000708 202020202C20483A30-     .p2		db	"    , H:0x"
   163 00000711 78                 
   164 00000712 20202C20533A3078        .p3		db	"  , S:0x"
   165 0000071A 20200A0D00              .p4		db	"  ", 0x0A, 0x0D, 0
   166                                  
   167 0000071F 43616E277420676574-     .e0		db	"Can't get drive parameter.", 0
   167 00000728 206472697665207061-
   167 00000731 72616D657465722E00 
   168                                  
   169                                  ;************************************************************************
   170                                  ;	ÉuÅ[ÉgèàóùÇÃëÊ3ÉXÉeÅ[ÉW
   171                                  ;************************************************************************
   172                                  stage_3rd:
   173                                  		;---------------------------------------
   174                                  		; ï∂éöóÒÇï\é¶
   175                                  		;---------------------------------------
   176 0000073A 68[B707]E880F983C4-     		cdecl	puts, .s0
   176 00000742 02                 
   177                                  
   178                                  		;---------------------------------------
   179                                  		; ÉvÉçÉeÉNÉgÉÇÅ[ÉhÇ≈égópÇ∑ÇÈÉtÉHÉìÉgÇÕÅA
   180                                  		; BIOSÇ…ì‡ë†Ç≥ÇÍÇΩÇ‡ÇÃÇó¨ópÇ∑ÇÈ
   181                                  		;---------------------------------------
   182 00000743 68[0002]E884FB83C4-     		cdecl	get_font_adr, FONT				; // BIOSÇÃÉtÉHÉìÉgÉAÉhÉåÉXÇéÊìæ
   182 0000074B 02                 
   183                                  
   184                                  		;---------------------------------------
   185                                  		; ÉtÉHÉìÉgÉAÉhÉåÉXÇÃï\é¶
   186                                  		;---------------------------------------
   187 0000074C 6A046A106A0468-         		cdecl	itoa, word [FONT.seg], .p1, 4, 16, 0b0100
   187 00000753 [D407]FF36[0002]E8-
   187 0000075A B0FA83C40A         
   188 0000075F 6A046A106A0468-         		cdecl	itoa, word [FONT.off], .p2, 4, 16, 0b0100
   188 00000766 [D907]FF36[0202]E8-
   188 0000076D 9DFA83C40A         
   189 00000772 68[C607]E848F983C4-     		cdecl	puts, .s1
   189 0000077A 02                 
   190                                  
   191                                  		;---------------------------------------
   192                                  		; ÉÅÉÇÉäèÓïÒÇÃéÊìæÇ∆ï\é¶
   193                                  		;---------------------------------------
   194 0000077B E86FFB                  		cdecl	get_mem_info					; get_mem_info();
   195                                  
   196 0000077E 66A1[0402]              		mov		eax, [ACPI_DATA.adr]			; EAX = ACPI_DATA.adr;
   197 00000782 6683F800                		cmp		eax, 0							; if (EAX)
   198 00000786 742D                    		je		.10E							; {
   199                                  
   200 00000788 6A046A106A0468-         		cdecl	itoa, ax, .p4, 4, 16, 0b0100	;   itoa(AX); // â∫à ÉAÉhÉåÉXÇïœä∑
   200 0000078F [F207]50E877FA83C4-
   200 00000797 0A                 
   201 00000798 66C1E810                		shr		eax, 16							;   EAX >>= 16;
   202 0000079C 6A046A106A0468-         		cdecl	itoa, ax, .p3, 4, 16, 0b0100	;   itoa(AX); // è„à ÉAÉhÉåÉXÇïœä∑
   202 000007A3 [EE07]50E863FA83C4-
   202 000007AB 0A                 
   203                                  
   204 000007AC 68[E307]E80EF983C4-     		cdecl	puts, .s2						;   puts(.s2); // ÉAÉhÉåÉXÇï\é¶
   204 000007B4 02                 
   205                                  .10E:											; }
   206                                  
   207                                  		;---------------------------------------
   208                                  		; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   209                                  		;---------------------------------------
   210 000007B5 EB42                    		jmp		stage_4							; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   211                                  
   212                                  		;---------------------------------------
   213                                  		; ÉfÅ[É^
   214                                  		;---------------------------------------
   215 000007B7 337264207374616765-     .s0:	db	"3rd stage...", 0x0A, 0x0D, 0
   215 000007C0 2E2E2E0A0D00       
   216                                  
   217 000007C6 20466F6E7420416464-     .s1:	db	" Font Address="
   217 000007CF 726573733D         
   218 000007D4 5A5A5A5A3A              .p1:	db	"ZZZZ:"
   219 000007D9 5A5A5A5A0A0D00          .p2:	db	"ZZZZ", 0x0A, 0x0D, 0
   220 000007E0 0A0D00                  		db	0x0A, 0x0D, 0
   221                                  
   222 000007E3 204143504920646174-     .s2:	db	" ACPI data="
   222 000007EC 613D               
   223 000007EE 5A5A5A5A                .p3:	db	"ZZZZ"
   224 000007F2 5A5A5A5A0A0D00          .p4:	db	"ZZZZ", 0x0A, 0x0D, 0
   225                                  
   226                                  ;************************************************************************
   227                                  ;	ÉuÅ[ÉgèàóùÇÃëÊ4ÉXÉeÅ[ÉW
   228                                  ;************************************************************************
   229                                  stage_4:
   230                                  		;---------------------------------------
   231                                  		; ï∂éöóÒÇï\é¶
   232                                  		;---------------------------------------
   233 000007F9 68[CD08]E8C1F883C4-     		cdecl	puts, .s0
   233 00000801 02                 
   234                                  
   235                                  		;---------------------------------------
   236                                  		; A20ÉQÅ[ÉgÇÃóLå¯âª
   237                                  		;---------------------------------------
   238 00000802 FA                      		cli										;   // äÑÇËçûÇ›ã÷é~
   239                                  												;   
   240 00000803 68AD00E8D5FD83C402      		cdecl	KBC_Cmd_Write, 0xAD				;   // ÉLÅ[É{Å[Éhñ≥å¯âª
   241                                  												;   
   242 0000080C 68D000E8CCFD83C402      		cdecl	KBC_Cmd_Write, 0xD0				;   // èoóÕÉ|Å[Égì«Ç›èoÇµÉRÉ}ÉìÉh
   243 00000815 68[1609]E89FFD83C4-     		cdecl	KBC_Data_Read, .key				;   // èoóÕÉ|Å[ÉgÉfÅ[É^
   243 0000081D 02                 
   244                                  												;   
   245 0000081E 8A1E[1609]              		mov		bl, [.key]						;   BL  = key;
   246 00000822 80CB02                  		or		bl, 0x02						;   BL |= 0x02; // A20ÉQÅ[ÉgóLå¯âª
   247                                  												;   
   248 00000825 68D100E8B3FD83C402      		cdecl	KBC_Cmd_Write, 0xD1				;   // èoóÕÉ|Å[ÉgèëÇ´çûÇ›ÉRÉ}ÉìÉh
   249 0000082E 53E86AFD83C402          		cdecl	KBC_Data_Write, bx				;   // èoóÕÉ|Å[ÉgÉfÅ[É^
   250                                  												;   
   251 00000835 68AE00E8A3FD83C402      		cdecl	KBC_Cmd_Write, 0xAE				;   // ÉLÅ[É{Å[ÉhóLå¯âª
   252                                  												;   
   253 0000083E FB                      		sti										;   // äÑÇËçûÇ›ãñâ¬
   254                                  
   255                                  		;---------------------------------------
   256                                  		; ï∂éöóÒÇï\é¶
   257                                  		;---------------------------------------
   258 0000083F 68[DC08]E87BF883C4-     		cdecl	puts, .s1
   258 00000847 02                 
   259                                  
   260                                  		;---------------------------------------
   261                                  		; ÉLÅ[É{Å[ÉhLEDÇÃÉeÉXÉg
   262                                  		;---------------------------------------
   263 00000848 68[F108]E872F883C4-     		cdecl	puts, .s2						; 
   263 00000850 02                 
   264                                  
   265 00000851 BB0000                  		mov		bx, 0							; CX = LEDÇÃèâä˙íl;
   266                                  .10L:											; do
   267                                  												; {
   268 00000854 B400                    		mov		ah, 0x00						;   // ÉLÅ[ì¸óÕë“Çø
   269 00000856 CD16                    		int		0x16							;   AL = BIOS(0x16, 0x00);
   270                                  												;   
   271 00000858 3C31                    		cmp		al, '1'							;   if (AL < '1')
   272 0000085A 7266                    		jb		.10E							;     break;
   273                                  												;   
   274 0000085C 3C33                    		cmp		al, '3'							;   if ('3' < AL)
   275 0000085E 7762                    		ja		.10E							;     break;
   276                                  												;   
   277 00000860 88C1                    		mov		cl, al							;   CL   = ÉLÅ[ì¸óÕ;
   278 00000862 FEC9                    		dec		cl								;   CL  -= 1;       // 1å∏éZ
   279 00000864 80E103                  		and		cl, 0x03						;   CL  &= 0x03;    // 0Å`2Ç…êßå¿
   280 00000867 B80100                  		mov		ax, 0x0001						;   AX   = 0x0001;  // ÉrÉbÉgïœä∑óp
   281 0000086A D3E0                    		shl		ax, cl							;   AX <<= CL;      // 0Å`2ÉrÉbÉgç∂ÉVÉtÉg
   282 0000086C 31C3                    		xor		bx, ax							;   BX  ^= AX;      // ÉrÉbÉgîΩì]
   283                                  
   284                                  		;---------------------------------------
   285                                  		; LEDÉRÉ}ÉìÉhÇÃëóêM
   286                                  		;---------------------------------------
   287 0000086E FA                      		cli										;   // äÑÇËçûÇ›ã÷é~
   288                                  												;   
   289 0000086F 68AD00E869FD83C402      		cdecl	KBC_Cmd_Write, 0xAD				;   // ÉLÅ[É{Å[Éhñ≥å¯âª
   290                                  												;   
   291 00000878 68ED00E81EFD83C402      		cdecl	KBC_Data_Write, 0xED			;   // LEDÉRÉ}ÉìÉh
   292 00000881 68[1609]E833FD83C4-     		cdecl	KBC_Data_Read, .key				;   // éÛêMâûìö
   292 00000889 02                 
   293                                  												;   
   294 0000088A 803E[1609]FA            		cmp		[.key], byte 0xFA				;   if (0xFA == key)
   295 0000088F 7509                    		jne		.11F							;   {
   296                                  												;     
   297 00000891 53E807FD83C402          		cdecl	KBC_Data_Write, bx				;     // LEDÉfÅ[É^èoóÕ
   298                                  												;   }
   299 00000898 EB1C                    		jmp		.11E							;   else
   300                                  .11F:											;   {
   301 0000089A 6A046A106A0268-         		cdecl	itoa, word [.key], .e1, 2, 16, 0b0100
   301 000008A1 [1209]FF36[1609]E8-
   301 000008A8 62F983C40A         
   302 000008AD 68[1109]E80DF883C4-     		cdecl	puts, .e0						;     // éÛêMÉRÅ[ÉhÇï\é¶
   302 000008B5 02                 
   303                                  .11E:											;   }
   304                                  												;   
   305 000008B6 68AE00E822FD83C402      		cdecl	KBC_Cmd_Write, 0xAE				;   // ÉLÅ[É{Å[ÉhóLå¯âª
   306                                  												;   
   307 000008BF FB                      		sti										;   // äÑÇËçûÇ›ãñâ¬
   308                                  												;   
   309 000008C0 EB92                    		jmp		.10L							; } while (1);
   310                                  .10E:
   311                                  
   312                                  		;---------------------------------------
   313                                  		; ï∂éöóÒÇï\é¶
   314                                  		;---------------------------------------
   315 000008C2 68[0709]E8F8F783C4-     		cdecl	puts, .s3
   315 000008CA 02                 
   316                                  
   317                                  		;---------------------------------------
   318                                  		; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   319                                  		;---------------------------------------
   320 000008CB EB4B                    		jmp		stage_5							; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   321                                  
   322 000008CD 347468207374616765-     .s0:	db	"4th stage...", 0x0A, 0x0D, 0
   322 000008D6 2E2E2E0A0D00       
   323 000008DC 204132302047617465-     .s1:	db	" A20 Gate Enabled.", 0x0A, 0x0D, 0
   323 000008E5 20456E61626C65642E-
   323 000008EE 0A0D00             
   324 000008F1 204B6579626F617264-     .s2:	db	" Keyboard LED Test...", 0
   324 000008FA 204C45442054657374-
   324 00000903 2E2E2E00           
   325 00000907 2028646F6E65290A0D-     .s3:	db	" (done)", 0x0A, 0x0D, 0
   325 00000910 00                 
   326 00000911 5B                      .e0:	db	"["
   327 00000912 5A5A5D00                .e1:	db	"ZZ]", 0
   328                                  
   329 00000916 0000                    .key:	dw	0
   330                                  
   331                                  ;************************************************************************
   332                                  ;	ÉuÅ[ÉgèàóùÇÃëÊ5ÉXÉeÅ[ÉW
   333                                  ;************************************************************************
   334                                  stage_5:
   335                                  		;---------------------------------------
   336                                  		; ï∂éöóÒÇï\é¶
   337                                  		;---------------------------------------
   338 00000918 68[4409]E8A2F783C4-     		cdecl	puts, .s0
   338 00000920 02                 
   339                                  
   340                                  		;---------------------------------------
   341                                  		; ÉJÅ[ÉlÉãÇì«Ç›çûÇﬁ
   342                                  		;---------------------------------------
   343 00000921 68009C6A106A1068-       		cdecl	read_lba, BOOT, BOOT_SECT, KERNEL_SECT, BOOT_END
   343 00000929 [B800]E809FD83C408 
   344                                  												; AX = read_lba(.lba, ...);
   345 00000931 83F810                  		cmp		ax, KERNEL_SECT					; if (AX != CX)
   346 00000934 740C                    .10Q:	jz		.10E							; {
   347 00000936 68[5309]E884F783C4-     .10T:	cdecl	puts, .e0						;   puts(.e0);
   347 0000093E 02                 
   348 0000093F E89DF7                  		call	reboot							;   reboot(); // çƒãNìÆ
   349                                  .10E:											; }
   350                                  												; 
   351                                  
   352                                  		;---------------------------------------
   353                                  		; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   354                                  		;---------------------------------------
   355 00000942 EB29                    		jmp		stage_6							; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   356                                  
   357 00000944 357468207374616765-     .s0		db	"5th stage...", 0x0A, 0x0D, 0
   357 0000094D 2E2E2E0A0D00       
   358 00000953 204661696C75726520-     .e0		db	" Failure load kernel...", 0x0A, 0x0D, 0
   358 0000095C 6C6F6164206B65726E-
   358 00000965 656C2E2E2E0A0D00   
   359                                  
   360                                  ;************************************************************************
   361                                  ;	ÉuÅ[ÉgèàóùÇÃëÊ6ÉXÉeÅ[ÉW
   362                                  ;************************************************************************
   363                                  stage_6:
   364                                  		;---------------------------------------
   365                                  		; ï∂éöóÒÇï\é¶
   366                                  		;---------------------------------------
   367 0000096D 68[8509]E84DF783C4-     		cdecl	puts, .s0
   367 00000975 02                 
   368                                  
   369                                  		;---------------------------------------
   370                                  		; ÉÜÅ[ÉUÅ[Ç©ÇÁÇÃì¸óÕë“Çø
   371                                  		;---------------------------------------
   372                                  .10L:											; do
   373                                  												; {
   374 00000976 B400                    		mov		ah, 0x00						;   // ÉLÅ[ì¸óÕë“Çø
   375 00000978 CD16                    		int		0x16							;   AL = BIOS(0x16, 0x00);
   376 0000097A 3C20                    		cmp		al, ' '							;   ZF = AL == ' ';
   377 0000097C 75F8                    		jne		.10L							; } while (!ZF);
   378                                  												; 
   379                                  
   380                                  		;---------------------------------------
   381                                  		; ÉrÉfÉIÉÇÅ[ÉhÇÃê›íË
   382                                  		;---------------------------------------
   383 0000097E B81200                  		mov		ax, 0x0012						; VGA 640x480
   384 00000981 CD10                    		int		0x10							; BIOS(0x10, 0x12); // ÉrÉfÉIÉÇÅ[ÉhÇÃê›íË
   385                                  
   386                                  		;---------------------------------------
   387                                  		; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   388                                  		;---------------------------------------
   389 00000983 EB5B                    		jmp		stage_7							; éüÇÃÉXÉeÅ[ÉWÇ÷à⁄çs
   390                                  
   391 00000985 367468207374616765-     .s0		db	"6th stage...", 0x0A, 0x0D, 0x0A, 0x0D
   391 0000098E 2E2E2E0A0D0A0D     
   392 00000995 205B50757368205350-     		db	" [Push SPACE key to protect mode...]", 0x0A, 0x0D, 0
   392 0000099E 414345206B65792074-
   392 000009A7 6F2070726F74656374-
   392 000009B0 206D6F64652E2E2E5D-
   392 000009B9 0A0D00             
   393                                  
   394                                  ;************************************************************************
   395                                  ;	GLOBAL DESCRIPTOR TABLE
   396                                  ;	(ÉZÉOÉÅÉìÉgÉfÉBÉXÉNÉäÉvÉ^ÇÃîzóÒ)
   397                                  ;************************************************************************
   398                                  ;
   399                                  ;   ÉZÉOÉÅÉìÉgÉfÉBÉXÉNÉäÉvÉ^
   400                                  ;
   401                                  ;        +--------+-----------------: Base (0xBBbbbbbb)
   402                                  ;        |   +----|--------+--------: Limit(0x000Lllll)
   403                                  ;        |   |    |        |
   404                                  ;       +--+--+--+--+--+--+--+--+
   405                                  ;       |B |FL|f |b       |l    |
   406                                  ;       +--+--+--+--+--+--+--+--+
   407                                  ;           |  |                         76543210
   408                                  ;           |  +--------------------: f:PDDSTTTA
   409                                  ;           |                          P:Exist
   410                                  ;           |                          D:DPL(ì¡å†)
   411                                  ;           |                          S:(DT)0=ÉVÉXÉeÉÄorÉQÅ[Ég, 1=ÉfÅ[É^ÉZÉOÉÅÉìÉg
   412                                  ;           |                          T:Type
   413                                  ;           |                            000(0)=R/- DATA
   414                                  ;           |                            001(1)=R/W DATA
   415                                  ;           |                            010(2)=R/- STACK
   416                                  ;           |                            011(3)=R/W STACK
   417                                  ;           |                            100(4)=R/- CODE
   418                                  ;           |                            101(5)=R/W CODE
   419                                  ;           |                            110(6)=R/- CONFORM
   420                                  ;           |                            111(7)=R/W CONFORM
   421                                  ;           |                          A:Accessed
   422                                  ;           |                       
   423                                  ;           +-----------------------: F:GD0ALLLL
   424                                  ;                                      G:Limit Scale(0=1, 1=4K)
   425                                  ;                                      D:Data/BandDown(0=16, 1=32Bit ÉZÉOÉÅÉìÉg)
   426                                  ;                                      A:any
   427                                  ;                                      L:Limit[19:16]
   428                                  ALIGN 4, db 0
   429                                  ;					  B_ F L f T b_____ l___
   430 000009BC 0000000000000000        GDT:			dq	0x00_0_0_0_0_000000_0000	; NULL
   431 000009C4 FFFF0000009ACF00        .cs:			dq	0x00_C_F_9_A_000000_FFFF	; CODE 4G
   432 000009CC FFFF00000092CF00        .ds:			dq	0x00_C_F_9_2_000000_FFFF	; DATA 4G
   433                                  .gdt_end:
   434                                  
   435                                  ;===============================================
   436                                  ;	ÉZÉåÉNÉ^
   437                                  ;===============================================
   438                                  SEL_CODE	equ	.cs - GDT						; ÉRÅ[ÉhópÉZÉåÉNÉ^
   439                                  SEL_DATA	equ	.ds - GDT						; ÉfÅ[É^ópÉZÉåÉNÉ^
   440                                  
   441                                  ;===============================================
   442                                  ;	GDT
   443                                  ;===============================================
   444 000009D4 1700                    GDTR:	dw 		GDT.gdt_end - GDT - 1			; ÉfÉBÉXÉNÉäÉvÉ^ÉeÅ[ÉuÉãÇÃÉäÉ~ÉbÉg
   445 000009D6 [BC090000]              		dd 		GDT								; ÉfÉBÉXÉNÉäÉvÉ^ÉeÅ[ÉuÉãÇÃÉAÉhÉåÉX
   446                                  
   447                                  ;===============================================
   448                                  ;	IDTÅiã^éóÅFäÑÇËçûÇ›ã÷é~Ç…Ç∑ÇÈà◊Åj
   449                                  ;===============================================
   450 000009DA 0000                    IDTR:	dw 		0								; idt_limit
   451 000009DC 00000000                		dd 		0								; idt location
   452                                  
   453                                  ;************************************************************************
   454                                  ;	ÉuÅ[ÉgèàóùÇÃëÊ7ÉXÉeÅ[ÉW
   455                                  ;************************************************************************
   456                                  stage_7:
   457 000009E0 FA                      		cli										; // äÑÇËçûÇ›ã÷é~
   458                                  
   459                                  		;---------------------------------------
   460                                  		; GDTÉçÅ[Éh
   461                                  		;---------------------------------------
   462 000009E1 0F0116[D409]            		lgdt	[GDTR]							; // ÉOÉçÅ[ÉoÉãÉfÉBÉXÉNÉäÉvÉ^ÉeÅ[ÉuÉãÇÉçÅ[Éh
   463 000009E6 0F011E[DA09]            		lidt	[IDTR]							; // äÑÇËçûÇ›ÉfÉBÉXÉNÉäÉvÉ^ÉeÅ[ÉuÉãÇÉçÅ[Éh
   464                                  
   465                                  		;---------------------------------------
   466                                  		; ÉvÉçÉeÉNÉgÉÇÅ[ÉhÇ÷à⁄çs
   467                                  		;---------------------------------------
   468 000009EB 0F20C0                  		mov		eax,cr0							; // PEÉrÉbÉgÇÉZÉbÉg
   469 000009EE 83C801                  		or		ax, 1							; CR0 |= 1;
   470 000009F1 0F22C0                  		mov		cr0,eax							; 
   471                                  
   472 000009F4 EB00                    		jmp		$ + 2							; êÊì«Ç›ÇÉNÉäÉA
   473                                  
   474                                  		;---------------------------------------
   475                                  		; ÉZÉOÉÅÉìÉgä‘ÉWÉÉÉìÉv
   476                                  		;---------------------------------------
   477                                  [BITS 32]
   478 000009F6 66                      		DB		0x66							; ÉIÉyÉâÉìÉhÉTÉCÉYÉIÅ[ÉoÅ[ÉâÉCÉhÉvÉåÉtÉBÉbÉNÉX
   479 000009F7 EA[FE090000]0800        		jmp		SEL_CODE:CODE_32
   480                                  
   481                                  ;************************************************************************
   482                                  ;	32ÉrÉbÉgÉRÅ[ÉhäJén
   483                                  ;************************************************************************
   484                                  CODE_32:
   485                                  
   486                                  		;---------------------------------------
   487                                  		; ÉZÉåÉNÉ^Çèâä˙âª
   488                                  		;---------------------------------------
   489 000009FE 66B81000                		mov		ax, SEL_DATA					;
   490 00000A02 8ED8                    		mov		ds, ax							;
   491 00000A04 8EC0                    		mov		es, ax							;
   492 00000A06 8EE0                    		mov		fs, ax							;
   493 00000A08 8EE8                    		mov		gs, ax							;
   494 00000A0A 8ED0                     		mov		ss, ax							;
   495                                  
   496                                  		;---------------------------------------
   497                                  		; ÉJÅ[ÉlÉãïîÇÉRÉsÅ[
   498                                  		;---------------------------------------
   499 00000A0C B900080000              		mov		ecx, (KERNEL_SIZE) / 4			; ECX = 4ÉoÉCÉgíPà Ç≈ÉRÉsÅ[;
   500 00000A11 BE009C0000              		mov		esi, BOOT_END					; ESI = 0x0000_9C00; // ÉJÅ[ÉlÉãïî
   501 00000A16 BF00101000              		mov		edi, KERNEL_LOAD				; EDI = 0x0010_1000; // è„à ÉÅÉÇÉä
   502 00000A1B FC                      		cld										; // DFÉNÉäÉAÅi+ï˚å¸Åj
   503 00000A1C F3A5                    		rep movsd								; while (--ECX) *EDI++ = *ESI++;
   504                                  
   505                                  		;---------------------------------------
   506                                  		; ÉJÅ[ÉlÉãèàóùÇ…à⁄çs
   507                                  		;---------------------------------------
   508 00000A1E E9(00101000)            		jmp		KERNEL_LOAD						; ÉJÅ[ÉlÉãÇÃêÊì™Ç…ÉWÉÉÉìÉv
   509                                  
   510                                  
   511                                  ;************************************************************************
   512                                  ;	ÉpÉfÉBÉìÉO
   513                                  ;************************************************************************
   514 00000A23 00<rep 15DDh>           		times BOOT_SIZE - ($ - $$)		db	0	; ÉpÉfÉBÉìÉO
   515                                  
