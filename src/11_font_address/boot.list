     1                                  ;************************************************************************
     2                                  ;	BIOSでロードされる最初のセクタ
     3                                  ;	
     4                                  ;	プログラム全体を通して、セグメントの値は0x0000とする。
     5                                  ;	(DS==ES==0)
     6                                  ;	
     7                                  ;************************************************************************
     8                                  
     9                                  ;************************************************************************
    10                                  ;	マクロ
    11                                  ;************************************************************************
    12                                  %include	"../include/define.s"
    13                              <1> ;************************************************************************
    14                              <1> ;	メモリイメージ
    15                              <1> ;************************************************************************
    16                              <1> 
    17                              <1> 		;---------------------------------------
    18                              <1> 		;           |            | 
    19                              <1> 		;           |____________| 
    20                              <1> 		; 0000_7A00 |            | ( 512) スタック
    21                              <1> 		;           |____________| 
    22                              <1> 		; 0000_7C00 |            | (  8K) ブート
    23                              <1> 		;           =            = 
    24                              <1> 		;           |____________| 
    25                              <1> 		; 0000_9C00 |            | (  8K) カーネル（一時展開）
    26                              <1> 		;           =            = 
    27                              <1> 		;           |____________| 
    28                              <1> 		; 0000_BC00 |////////////| 
    29                              <1> 		;           =            = 
    30                              <1> 		;           |____________| 
    31                              <1> 		; 0010_0000 |       (2K) | 割り込みディスクリプタテーブル
    32                              <1> 		;           |____________| 
    33                              <1> 		; 0010_0800 |       (2K) | カーネルスタック
    34                              <1> 		;           |____________| 
    35                              <1> 		; 0010_1000 |       (8K) | カーネルプログラム
    36                              <1> 		;           |            | 
    37                              <1> 		;           =            = 
    38                              <1> 		;           |____________| 
    39                              <1> 		; 0010_3000 |       (8K) | タスク用スタック
    40                              <1> 		;           |            | （各タスク1K）
    41                              <1> 		;           =            = 
    42                              <1> 		;           |____________| 
    43                              <1> 		; 0010_5000 |            | Dir
    44                              <1> 		;      6000 |____________| Page
    45                              <1> 		; 0010_7000 |            | Dir
    46                              <1> 		;      8000 |____________| Page
    47                              <1> 		; 0010_9000 |////////////| 
    48                              <1> 		;           |            | 
    49                              <1> 
    50                              <1> 
    51                              <1>         BOOT_LOAD			equ		0x7C00			; ブートプログラムのロード位置
    52                              <1>         BOOT_SIZE			equ		(1024 * 8)		; ブートサイズ
    53                              <1>         SECT_SIZE			equ		(512)			; セクタサイズ
    54                              <1>         BOOT_SECT			equ		(BOOT_SIZE   / SECT_SIZE)	; ブートプログラムのセクタ数
    13                                  %include	"../include/macro.s"
    14                              <1> ;************************************************************************
    15                              <1> ; 関数呼び出し用マクロ
    16                              <1> ;
    17                              <1> ; 使い方：
    18                              <1> ;	cdecl	func [, param1[, param2[, ...]]]
    19                              <1> ;
    20                              <1> ;************************************************************************
    21                              <1> 
    22                              <1> %macro cdecl 1-*.nolist
    23                              <1> 
    24                              <1>     %rep %0 - 1
    25                              <1>         push    %{-1:-1}
    26                              <1>         %rotate -1
    27                              <1>     %endrep
    28                              <1>     %rotate -1
    29                              <1> 
    30                              <1>         call    %1
    31                              <1> 
    32                              <1>     %if 1 < %0
    33                              <1>         add     sp,(__BITS__ >> 3) * (%0 - 1)
    34                              <1>     %endif
    35                              <1> 
    36                              <1> %endmacro
    37                              <1> 
    38                              <1> ;************************************************************************
    39                              <1> ;	構造体
    40                              <1> ;************************************************************************
    41                              <1> 
    42                              <1> ;-----------------------------------------------
    43                              <1> ;	ドライブパラメータ
    44                              <1> ;-----------------------------------------------
    45                              <1> struc drive
    46 00000000 ????                <1> 		.no				resw	1				; ドライブ番号
    47 00000002 ????                <1> 		.cyln			resw	1				; C:シリンダ
    48 00000004 ????                <1> 		.head			resw	1				; H:ヘッド
    49 00000006 ????                <1> 		.sect			resw	1				; S:セクタ
    50                              <1> endstruc
    14                                  
    15                                  		ORG		BOOT_LOAD						; ロードアドレスをアセンブラに指示
    16                                  
    17                                  ;************************************************************************
    18                                  ;	エントリポイント
    19                                  ;************************************************************************
    20                                  entry:
    21                                  		;---------------------------------------
    22                                  		; BPB(BIOS Parameter Block)
    23                                  		;---------------------------------------
    24 00000000 EB58                    		jmp		ipl								; IPLへジャンプ
    25 00000002 90<rep 58h>             		times	90 - ($ - $$) db 0x90			; 
    26                                  
    27                                  		;---------------------------------------
    28                                  		; IPL(Initial Program Loader)
    29                                  		;---------------------------------------
    30                                  ipl:
    31 0000005A FA                      		cli										; // 割り込み禁止
    32                                  
    33 0000005B B80000                  		mov		ax, 0x0000						; AX = 0x0000;
    34 0000005E 8ED8                    		mov		ds, ax							; DS = 0x0000;
    35 00000060 8EC0                    		mov		es, ax							; ES = 0x0000;
    36 00000062 8ED0                    		mov		ss, ax							; SS = 0x0000;
    37 00000064 BC007C                  		mov		sp, BOOT_LOAD					; SP = 0x7C00;
    38                                  
    39 00000067 FB                      		sti										; // 割り込み許可
    40                                  
    41 00000068 8816[B800]              		mov		[BOOT + drive.no], dl			; ブートドライブを保存
    42                                  
    43                                  		;---------------------------------------
    44                                  		; 文字列を表示
    45                                  		;---------------------------------------
    46 0000006C 68[9900]E84E0083C4-     		cdecl	puts, .s0						; puts(.s0);
    46 00000074 02                 
    47                                  
    48                                  		;---------------------------------------
    49                                  		; 残りのセクタを全て読み込む
    50                                  		;---------------------------------------
    51 00000075 BB0F00                  		mov		bx, BOOT_SECT - 1				; BX = 残りのブートセクタ数;
    52 00000078 B9007E                  		mov		cx, BOOT_LOAD + SECT_SIZE		; CX = 次のロードアドレス;
    53                                  
    54 0000007B 515368[B800]E89B00-     		cdecl	read_chs, BOOT, bx, cx			; AX = read_chs(.chs, bx, cx);
    54 00000083 83C406             
    55                                  
    56 00000086 39D8                    		cmp		ax, bx							; if (AX != 残りのセクタ数)
    57 00000088 740C                    .10Q:	jz		.10E							; {
    58 0000008A 68[A600]E8300083C4-     .10T:	cdecl	puts, .e0						;   puts(.e0);
    58 00000092 02                 
    59 00000093 E84900                  		call	reboot							;   reboot(); // 再起動
    60                                  .10E:											; }
    61                                  
    62                                  		;---------------------------------------
    63                                  		; 次のステージへ移行
    64                                  		;---------------------------------------
    65 00000096 E94C02                  		jmp		stage_2							; ブート処理の第2ステージ
    66                                  
    67                                  		;---------------------------------------
    68                                  		; データ
    69                                  		;---------------------------------------
    70 00000099 426F6F74696E672E2E-     .s0		db	"Booting...", 0x0A, 0x0D, 0
    70 000000A2 2E0A0D00           
    71 000000A6 4572726F723A736563-     .e0		db	"Error:sector read", 0
    71 000000AF 746F72207265616400 
    72                                  
    73                                  ;************************************************************************
    74                                  ;	ブートドライブに関する情報
    75                                  ;************************************************************************
    76                                  ALIGN 2, db 0
    77                                  BOOT:											; ブートドライブに関する情報
    78                                  	istruc	drive
    79 000000B8 0000                    		at	drive.no,		dw	0				; ドライブ番号
    80 000000BA 0000                    		at	drive.cyln,		dw	0				; C:シリンダ
    81 000000BC 0000                    		at	drive.head,		dw	0				; H:ヘッド
    82 000000BE 0200                    		at	drive.sect,		dw	2				; S:セクタ
    83                                  	iend
    84                                  
    85                                  ;************************************************************************
    86                                  ;	モジュール
    87                                  ;************************************************************************
    88                                  %include	"../modules/real/puts.s"
    89                              <1> ;************************************************************************
    90                              <1> ;	文字列表示
    91                              <1> ;------------------------------------------------------------------------
    92                              <1> ;	BIOS を使用
    93                              <1> ;========================================================================
    94                              <1> ;■書式		: void puts(str);
    95                              <1> ;
    96                              <1> ;■引数
    97                              <1> ;	str		: 文字列のアドレス
    98                              <1> ;
    99                              <1> ;■戻り値	: 無し
   100                              <1> ;************************************************************************
   101                              <1> puts:
   102                              <1> 		;---------------------------------------
   103                              <1> 		; 【スタックフレームの構築】
   104                              <1> 		;---------------------------------------
   105                              <1> 												; ------|--------
   106                              <1> 												;    + 4| 文字列のアドレス
   107                              <1> 												;    + 2| IP（戻り番地）
   108 000000C0 55                  <1> 		push	bp								;  BP+ 0| BP（元の値）
   109 000000C1 89E5                <1> 		mov		bp, sp							; ------+--------
   110                              <1> 
   111                              <1> 		;---------------------------------------
   112                              <1> 		; 【レジスタの保存】
   113                              <1> 		;---------------------------------------
   114 000000C3 50                  <1> 		push	ax
   115 000000C4 53                  <1> 		push	bx
   116 000000C5 56                  <1> 		push	si
   117                              <1> 
   118                              <1> 		;---------------------------------------
   119                              <1> 		; 引数を取得
   120                              <1> 		;---------------------------------------
   121 000000C6 8B7604              <1> 		mov		si, [bp + 4]					; SI = 文字列のアドレス;
   122                              <1> 
   123                              <1> 		;---------------------------------------
   124                              <1> 		; 【処理の開始】
   125                              <1> 		;---------------------------------------
   126 000000C9 B40E                <1> 		mov		ah, 0x0E						; // テレタイプ式1文字出力
   127 000000CB BB0000              <1> 		mov		bx, 0x0000						; // ページ番号と文字色を0に設定
   128 000000CE FC                  <1> 		cld										; DF = 0; // アドレス加算
   129                              <1> .10L:											; do
   130                              <1> 												; {
   131 000000CF AC                  <1> 		lodsb									;   AL = *SI++;
   132                              <1> 												;   
   133 000000D0 3C00                <1> 		cmp		al, 0							;   if (0 == AL)
   134 000000D2 7404                <1> 		je		.10E							;     break;
   135                              <1> 												;   
   136 000000D4 CD10                <1> 		int		0x10							;   Int10(0x0E, AL); // 文字出力
   137 000000D6 EBF7                <1> 		jmp		.10L							;   
   138                              <1> .10E:											; } while (1);
   139                              <1> 
   140                              <1> 		;---------------------------------------
   141                              <1> 		; 【レジスタの復帰】
   142                              <1> 		;---------------------------------------
   143 000000D8 5E                  <1> 		pop		si
   144 000000D9 5B                  <1> 		pop		bx
   145 000000DA 58                  <1> 		pop		ax
   146                              <1> 
   147                              <1> 		;---------------------------------------
   148                              <1> 		; 【スタックフレームの破棄】
   149                              <1> 		;---------------------------------------
   150 000000DB 89EC                <1> 		mov		sp, bp
   151 000000DD 5D                  <1> 		pop		bp
   152                              <1> 
   153 000000DE C3                  <1> 		ret
   154                              <1> 
    89                                  %include	"../modules/real/reboot.s"
    90                              <1> ;************************************************************************
    91                              <1> ;	メッセージを表示して再起動を行う
    92                              <1> ;========================================================================
    93                              <1> ;■書式		: void reboot(void);
    94                              <1> ;
    95                              <1> ;■引数		: 無し
    96                              <1> ;
    97                              <1> ;■戻り値;	: 無し
    98                              <1> ;************************************************************************
    99                              <1> reboot:
   100                              <1> 		;---------------------------------------
   101                              <1> 		; メッセージを表示
   102                              <1> 		;---------------------------------------
   103 000000DF 68[FB00]E8DBFF83C4- <1> 		cdecl	puts, .s0						; // 再起動メッセージを表示
   103 000000E7 02                  <1>
   104                              <1> 
   105                              <1> 		;---------------------------------------
   106                              <1> 		; キー入力待ち
   107                              <1> 		;---------------------------------------
   108                              <1> .10L:											; do
   109                              <1> 												; {
   110 000000E8 B410                <1> 		mov		ah, 0x10						;   // キー入力待ち
   111 000000EA CD16                <1> 		int		0x16							;   AL = BIOS(0x16, 0x10);
   112                              <1> 												;   
   113 000000EC 3C20                <1> 		cmp		al, ' '							;   ZF = AL == ' ';
   114 000000EE 75F8                <1> 		jne		.10L							; } while (!ZF);
   115                              <1> 
   116                              <1> 		;---------------------------------------
   117                              <1> 		; 改行を出力
   118                              <1> 		;---------------------------------------
   119 000000F0 68[1901]E8CAFF83C4- <1> 		cdecl	puts, .s1						; 改行
   119 000000F8 02                  <1>
   120                              <1> 
   121                              <1> 		;---------------------------------------
   122                              <1> 		; 再起動
   123                              <1> 		;---------------------------------------
   124 000000F9 CD19                <1> 		int		0x19							; BIOS(0x19);       // reboot();
   125                              <1> 
   126                              <1> 		;---------------------------------------
   127                              <1> 		; 文字列データ
   128                              <1> 		;---------------------------------------
   129 000000FB 0A0D50757368205350- <1> .s0		db	0x0A, 0x0D, "Push SPACE key to reboot...", 0
   129 00000104 414345206B65792074- <1>
   129 0000010D 6F207265626F6F742E- <1>
   129 00000116 2E2E00              <1>
   130 00000119 0A0D0A0D00          <1> .s1		db	0x0A, 0x0D, 0x0A, 0x0D, 0
   131                              <1> 
    90                                  %include	"../modules/real/read_chs.s"
    91                              <1> ;************************************************************************
    92                              <1> ;	セクタ読み込み（CHS指定）
    93                              <1> ;------------------------------------------------------------------------
    94                              <1> ;	BIOSコール（INT13 AH=0x02）を使ったセクタ読み出し
    95                              <1> ;========================================================================
    96                              <1> ;■書式		: WORD read_chs(drive, sect, dst);
    97                              <1> ;
    98                              <1> ;■引数
    99                              <1> ;	drive	: drive構造体のアドレス
   100                              <1> ;	sect	: 読み出しセクタ数
   101                              <1> ;	dst		: 読み出し先アドレス
   102                              <1> ;
   103                              <1> ;■戻り値	: 読み込んだセクタ数
   104                              <1> ;************************************************************************
   105                              <1> read_chs:
   106                              <1> 		;---------------------------------------
   107                              <1> 		; 【スタックフレームの構築】
   108                              <1> 		;---------------------------------------
   109                              <1> 												; ------|--------
   110                              <1> 												;    + 8| コピー先
   111                              <1> 												;    + 6| セクタ数
   112                              <1> 												;    + 4| パラメータバッファ
   113                              <1> 												; ------+----------------
   114                              <1> 												;    + 2| IP（戻り番地）
   115 0000011E 55                  <1> 		push	bp								;  BP+ 0| BP（元の値）
   116 0000011F 89E5                <1> 		mov		bp, sp							; ------+--------
   117 00000121 6A03                <1> 		push	3								;    - 2| retry = 3; // リトライ回数
   118 00000123 6A00                <1> 		push	0								;    - 4| sect  = 0; // 読み込みセクタ数
   119                              <1> 
   120                              <1> 		;---------------------------------------
   121                              <1> 		; 【レジスタの保存】
   122                              <1> 		;---------------------------------------
   123 00000125 53                  <1> 		push	bx
   124 00000126 51                  <1> 		push	cx
   125 00000127 52                  <1> 		push	dx
   126 00000128 06                  <1> 		push	es
   127 00000129 56                  <1> 		push	si
   128                              <1> 
   129                              <1> 		;---------------------------------------
   130                              <1> 		; 【処理の開始】
   131                              <1> 		;---------------------------------------
   132 0000012A 8B7604              <1> 		mov		si, [bp + 4]					; SI = SRCバッファ;
   133                              <1> 
   134                              <1> 		;---------------------------------------
   135                              <1> 		; CXレジスタの設定
   136                              <1> 		;（BIOSコールの呼び出しに適した形に変換）
   137                              <1> 		;---------------------------------------
   138 0000012D 8A6C02              <1> 		mov		ch, [si + drive.cyln + 0]		; CH   = シリンダ番号（下位バイト）
   139 00000130 8A4C03              <1> 		mov		cl, [si + drive.cyln + 1]		; CL   = シリンダ番号（上位バイト）
   140 00000133 C0E106              <1> 		shl		cl, 6							; CL <<= 6; // 最上位2ビットにシフト
   141 00000136 0A4C06              <1> 		or		cl, [si + drive.sect]			; CL  |= セクタ番号;
   142                              <1> 
   143                              <1> 		;---------------------------------------
   144                              <1> 		; セクタ読み込み
   145                              <1> 		;---------------------------------------
   146 00000139 8A7404              <1> 		mov		dh, [si + drive.head]			; DH = ヘッド番号;
   147 0000013C 8A14                <1> 		mov		dl, [si + 0]					; DL = ドライブ番号;
   148 0000013E B80000              <1> 		mov		ax, 0x0000						; AX = 0x0000;
   149 00000141 8EC0                <1> 		mov		es, ax							; ES = セグメント
   150 00000143 8B5E08              <1> 		mov		bx, [bp + 8]					; BX = コピー先;
   151                              <1> .10L:											; do
   152                              <1> 												; {
   153 00000146 B402                <1> 		mov		ah, 0x02						;   AH = セクタ読み込み
   154 00000148 8A4606              <1> 		mov		al, [bp + 6]					;   AL = セクタ数
   155                              <1> 												;   
   156 0000014B CD13                <1> 		int		0x13							;   CF = BIOS(0x13, 0x02);
   157 0000014D 7304                <1> 		jnc		.11E							;   if (CF)
   158                              <1> 												;   {
   159 0000014F B000                <1> 		mov		al, 0							;     AL = 0;
   160 00000151 EB0C                <1> 		jmp		.10E							;     break;
   161                              <1> .11E:											;   }
   162                              <1> 												;   
   163 00000153 3C00                <1> 		cmp		al, 0							;   if (読み込んだセクタがあれば)
   164 00000155 7508                <1> 		jne		.10E							;     break;
   165                              <1> 												;   
   166 00000157 B80000              <1> 		mov		ax, 0							;   ret = 0; // 戻り値を設定
   167 0000015A FF4EFE              <1> 		dec		word [bp - 2]					; }
   168 0000015D 75E7                <1> 		jnz		.10L							; while (--retry);
   169                              <1> .10E:
   170 0000015F B400                <1> 		mov		ah, 0							; AH = 0; // ステータス情報は破棄
   171                              <1> 
   172                              <1> 		;---------------------------------------
   173                              <1> 		; 【レジスタの復帰】
   174                              <1> 		;---------------------------------------
   175 00000161 5E                  <1> 		pop		si
   176 00000162 07                  <1> 		pop		es
   177 00000163 5A                  <1> 		pop		dx
   178 00000164 59                  <1> 		pop		cx
   179 00000165 5B                  <1> 		pop		bx
   180                              <1> 
   181                              <1> 		;---------------------------------------
   182                              <1> 		; 【スタックフレームの破棄】
   183                              <1> 		;---------------------------------------
   184 00000166 89EC                <1> 		mov		sp, bp
   185 00000168 5D                  <1> 		pop		bp
   186                              <1> 
   187 00000169 C3                  <1> 		ret
   188                              <1> 
    91                                  
    92                                  ;************************************************************************
    93                                  ;	ブートフラグ（先頭512バイトの終了）
    94                                  ;************************************************************************
    95 0000016A 00<rep 94h>             		times	510 - ($ - $$) db 0x00
    96 000001FE 55AA                    		db	0x55, 0xAA
    97                                  
    98                                  ;************************************************************************
    99                                  ;	リアルモード時に取得した情報
   100                                  ;************************************************************************
   101                                  FONT:											; フォント
   102 00000200 0000                    .seg:	dw	0
   103 00000202 0000                    .off:	dw	0
   104                                  
   105                                  ;************************************************************************
   106                                  ;	モジュール（先頭512バイト以降に配置）
   107                                  ;************************************************************************
   108                                  %include	"../modules/real/itoa.s"
   109                              <1> ;************************************************************************
   110                              <1> ;	数値を文字に変換
   111                              <1> ;========================================================================
   112                              <1> ;■書式		: void itoa(num, buff, size, radix, flags);
   113                              <1> ;
   114                              <1> ;■引数
   115                              <1> ;	num		: 変換する数値
   116                              <1> ;	buff	: 保存先バッファアドレス
   117                              <1> ;	size	: 保存先バッファサイズ
   118                              <1> ;	radix	: 基数（2、8、10又は16を設定する）
   119                              <1> ;	flags	: フラグ
   120                              <1> ;			:   B2 : 1=空白を'0'（ゼロ）で埋める
   121                              <1> ;			:      : 0=空白を' '（スペース）で埋める
   122                              <1> ;			:   B1 : 1=＋/-符号を表示する
   123                              <1> ;			:      : 0=＋/-符号を表示しない
   124                              <1> ;			:   B0 : 1=符号付き正数として扱う
   125                              <1> ;			:      : 0=符号無し正数として扱う
   126                              <1> ;
   127                              <1> ;■戻り値	: 無し
   128                              <1> ;************************************************************************
   129                              <1> itoa:
   130                              <1> 		;---------------------------------------
   131                              <1> 		; 【スタックフレームの構築】
   132                              <1> 		;---------------------------------------
   133                              <1> 												; ------|--------
   134                              <1> 												;    +12| フラグ
   135                              <1> 												;    +10| 基数
   136                              <1> 												;    + 8| バッファサイズ
   137                              <1> 												;    + 6| バッファアドレス
   138                              <1> 												;    + 4| 数値
   139                              <1> 												; ------|--------
   140                              <1> 												;    + 2| IP（戻り番地）
   141 00000204 55                  <1> 		push	bp								;  BP+ 0| BP（元の値）
   142 00000205 89E5                <1> 		mov		bp, sp							; ------+--------
   143                              <1> 
   144                              <1> 		;---------------------------------------
   145                              <1> 		; 【レジスタの保存】
   146                              <1> 		;---------------------------------------
   147 00000207 50                  <1> 		push	ax
   148 00000208 53                  <1> 		push	bx
   149 00000209 51                  <1> 		push	cx
   150 0000020A 52                  <1> 		push	dx
   151 0000020B 56                  <1> 		push	si
   152 0000020C 57                  <1> 		push	di
   153                              <1> 
   154                              <1> 		;---------------------------------------
   155                              <1> 		; 引数を取得
   156                              <1> 		;---------------------------------------
   157 0000020D 8B4604              <1> 		mov		ax, [bp + 4]					; val  = 数値;
   158 00000210 8B7606              <1> 		mov		si, [bp + 6]					; dst  = バッファアドレス;
   159 00000213 8B4E08              <1> 		mov		cx, [bp + 8]					; size = 残りバッファサイズ;
   160                              <1> 
   161 00000216 89F7                <1> 		mov		di, si							; // バッファの最後尾
   162 00000218 01CF                <1> 		add		di, cx							; dst  = &dst[size - 1];
   163 0000021A 4F                  <1> 		dec		di								; 
   164                              <1> 
   165 0000021B 8B5E0C              <1> 		mov		bx, [bp +12]					; flags = オプション;
   166                              <1> 
   167                              <1> 		;---------------------------------------
   168                              <1> 		; 符号付き判定
   169                              <1> 		;---------------------------------------
   170 0000021E F7C30100            <1> 		test	bx, 0b0001						; if (flags & 0x01)// 符号付き
   171 00000222 7408                <1> .10Q:	je		.10E							; {
   172 00000224 83F800              <1> 		cmp		ax, 0							;   if (val < 0)
   173 00000227 7D03                <1> .12Q:	jge		.12E							;   {
   174 00000229 83CB02              <1> 		or		bx, 0b0010						;     flags |=  2; // 符号表示
   175                              <1> .12E:											;   }
   176                              <1> .10E:											; }
   177                              <1> 
   178                              <1> 		;---------------------------------------
   179                              <1> 		; 符号出力判定
   180                              <1> 		;---------------------------------------
   181 0000022C F7C30200            <1> 		test	bx, 0b0010						; if (flags & 0x02)// 符号出力判定
   182 00000230 7410                <1> .20Q:	je		.20E							; {
   183 00000232 83F800              <1> 		cmp		ax, 0							;   if (val < 0)
   184 00000235 7D07                <1> .22Q:	jge		.22F							;   {
   185 00000237 F7D8                <1> 		neg		ax								;     val *= -1;   // 符号反転
   186 00000239 C6042D              <1> 		mov		[si], byte '-'					;     *dst = '-';  // 符号表示
   187 0000023C EB03                <1> 		jmp		.22E							;   }
   188                              <1> .22F:											;   else
   189                              <1> 												;   {
   190 0000023E C6042B              <1> 		mov		[si], byte '+'					;     *dst = '+';  // 符号表示
   191                              <1> .22E:											;   }
   192 00000241 49                  <1> 		dec		cx								;   size--;        // 残りバッファサイズの減算
   193                              <1> .20E:											; }
   194                              <1> 
   195                              <1> 		;---------------------------------------
   196                              <1> 		; ASCII変換
   197                              <1> 		;---------------------------------------
   198 00000242 8B5E0A              <1> 		mov		bx, [bp +10]					; BX = 基数;
   199                              <1> .30L:											; do
   200                              <1> 												; {
   201 00000245 BA0000              <1> 		mov		dx, 0							;   
   202 00000248 F7F3                <1> 		div		bx								;   DX = DX:AX % 基数;
   203                              <1> 												;   AX = DX:AX / 基数;
   204                              <1> 												;   
   205 0000024A 89D6                <1> 		mov		si, dx							;   // テーブル参照
   206 0000024C 8A94[7402]          <1> 		mov		dl, byte [.ascii + si]			;   DL = ASCII[DX];
   207                              <1> 												;   
   208 00000250 8815                <1> 		mov		[di], dl						;   *dst = DL;
   209 00000252 4F                  <1> 		dec		di								;   dst--;
   210                              <1> 												;   
   211 00000253 83F800              <1> 		cmp		ax, 0							;   
   212 00000256 E0ED                <1> 		loopnz	.30L							; } while (AX);
   213                              <1> .30E:
   214                              <1> 
   215                              <1> 		;---------------------------------------
   216                              <1> 		; 空欄を埋める
   217                              <1> 		;---------------------------------------
   218 00000258 83F900              <1> 		cmp		cx, 0							; if (size)
   219 0000025B 740D                <1> .40Q:	je		.40E							; {
   220 0000025D B020                <1> 		mov		al, ' '							;   AL = ' ';  // ' 'で埋める（デフォルト値）
   221 0000025F 837E0C04            <1> 		cmp		[bp +12], word 0b0100			;   if (flags & 0x04)
   222 00000263 7502                <1> .42Q:	jne		.42E							;   {
   223 00000265 B030                <1> 		mov		al, '0'							;     AL = '0'; // '0'で埋める
   224                              <1> .42E:											;   }
   225 00000267 FD                  <1> 		std										;   // DF = 1（-方向）
   226 00000268 F3AA                <1> 		rep stosb								;   while (--CX) *DI-- = ' ';
   227                              <1> .40E:											; }
   228                              <1> 
   229                              <1> 		;---------------------------------------
   230                              <1> 		; 【レジスタの復帰】
   231                              <1> 		;---------------------------------------
   232 0000026A 5F                  <1> 		pop		di
   233 0000026B 5E                  <1> 		pop		si
   234 0000026C 5A                  <1> 		pop		dx
   235 0000026D 59                  <1> 		pop		cx
   236 0000026E 5B                  <1> 		pop		bx
   237 0000026F 58                  <1> 		pop		ax
   238                              <1> 
   239                              <1> 		;---------------------------------------
   240                              <1> 		; 【スタックフレームの破棄】
   241                              <1> 		;---------------------------------------
   242 00000270 89EC                <1> 		mov		sp, bp
   243 00000272 5D                  <1> 		pop		bp
   244                              <1> 
   245 00000273 C3                  <1> 		ret
   246                              <1> 
   247 00000274 303132333435363738- <1> .ascii	db		"0123456789ABCDEF"				; 変換テーブル
   247 0000027D 39414243444546      <1>
   248                              <1> 
   109                                  %include	"../modules/real/get_drive_param.s"
   110                              <1> ;************************************************************************
   111                              <1> ;	ドライブ情報の取得(LBA変換に必要な情報)
   112                              <1> ;------------------------------------------------------------------------
   113                              <1> ;	アクセス可能な最大セクタをdrive構造体に設定する
   114                              <1> ;	注）ドライブ番号（drive.no）を設定後に呼び出す事
   115                              <1> ;========================================================================
   116                              <1> ;■書式		: WORD get_drive_param(drive);
   117                              <1> ;
   118                              <1> ;■引数
   119                              <1> ;	drive	: drive構造体のアドレス
   120                              <1> ;
   121                              <1> ;■戻り値	: 成功(0以外)、失敗(0)
   122                              <1> ;************************************************************************
   123                              <1> get_drive_param:
   124                              <1> 		;---------------------------------------
   125                              <1> 		; 【スタックフレームの構築】
   126                              <1> 		;---------------------------------------
   127                              <1> 												; ------|--------
   128                              <1> 												;    + 4| パラメータバッファ
   129                              <1> 												;    + 2| IP（戻り番地）
   130 00000284 55                  <1> 		push	bp								;  BP+ 0| BP（元の値）
   131 00000285 89E5                <1> 		mov		bp, sp							; ------+--------
   132                              <1> 
   133                              <1> 		;---------------------------------------
   134                              <1> 		; 【レジスタの保存】
   135                              <1> 		;---------------------------------------
   136 00000287 53                  <1> 		push	bx
   137 00000288 51                  <1> 		push	cx
   138 00000289 06                  <1> 		push	es
   139 0000028A 56                  <1> 		push	si
   140 0000028B 57                  <1> 		push	di
   141                              <1> 
   142                              <1> 		;---------------------------------------
   143                              <1> 		; 【処理の開始】
   144                              <1> 		;---------------------------------------
   145 0000028C 8B7604              <1> 		mov		si, [bp + 4]					; SI = バッファ
   146                              <1> 
   147 0000028F B80000              <1> 		mov		ax, 0							; Disk Base Table Pointerの初期化
   148 00000292 8EC0                <1> 		mov		es, ax							; ES = 0;
   149 00000294 89C7                <1> 		mov		di, ax							; DI = 0;
   150                              <1> 
   151 00000296 B408                <1> 		mov		ah, 0x08						; // get drive parameters 
   152 00000298 8A14                <1> 		mov		dl, [si + drive.no]				; DL = ドライブ番号
   153 0000029A CD13                <1> 		int		0x13							; CF = BIOS(0x13, 0x08);
   154 0000029C 721B                <1> .10Q:	jc		.10F							; if (0 == CF)
   155                              <1> .10T:											; {
   156 0000029E 88C8                <1> 		mov		al, cl							;   AX = セクタ数
   157 000002A0 83E03F              <1> 		and		ax, 0x3F						;   // 下位6ビットのみ有効
   158                              <1> 
   159 000002A3 C0E906              <1> 		shr		cl, 6							;   CX = シリンダ数
   160 000002A6 C1C908              <1> 		ror		cx, 8							;   
   161 000002A9 41                  <1> 		inc		cx								;   
   162                              <1> 
   163 000002AA 0FB6DE              <1> 		movzx	bx, dh							;   BX = ヘッド数（1ベース）
   164 000002AD 43                  <1> 		inc		bx								;   
   165                              <1> 
   166 000002AE 894C02              <1> 		mov		[si + drive.cyln], cx			;   drive.syln = CX; // C:シリンダ数
   167 000002B1 895C04              <1> 		mov		[si + drive.head], bx			;   drive.head = BX; // H:ヘッド数
   168 000002B4 894406              <1> 		mov		[si + drive.sect], ax			;   drive.sect = AX; // S:セクタ数
   169                              <1> 
   170 000002B7 EB03                <1> 		jmp		.10E							; }
   171                              <1> .10F:											; else
   172                              <1> 												; {
   173 000002B9 B80000              <1> 		mov		ax, 0							;   AX = 0; // 失敗
   174                              <1> .10E:											; }
   175                              <1> 
   176                              <1> 		;---------------------------------------
   177                              <1> 		; 【レジスタの復帰】
   178                              <1> 		;---------------------------------------
   179 000002BC 5F                  <1> 		pop		di
   180 000002BD 5E                  <1> 		pop		si
   181 000002BE 07                  <1> 		pop		es
   182 000002BF 59                  <1> 		pop		cx
   183 000002C0 5B                  <1> 		pop		bx
   184                              <1> 
   185                              <1> 		;---------------------------------------
   186                              <1> 		; 【スタックフレームの破棄】
   187                              <1> 		;---------------------------------------
   188 000002C1 89EC                <1> 		mov		sp, bp
   189 000002C3 5D                  <1> 		pop		bp
   190                              <1> 
   191 000002C4 C3                  <1> 		ret
   192                              <1> 
   110                                  %include	"../modules/real/get_font_adr.s"
   111                              <1> ;************************************************************************
   112                              <1> ;	BIOSフォントアドレスを取得
   113                              <1> ;------------------------------------------------------------------------
   114                              <1> ;	フォント8x16ドットのフォントアドレスを取得
   115                              <1> ;========================================================================
   116                              <1> ;■書式		: void get_font_adr(adr);
   117                              <1> ;
   118                              <1> ;■引数
   119                              <1> ;	adr		: フォントアドレス格納位置
   120                              <1> ;
   121                              <1> ;■戻り値;	: 無し
   122                              <1> ;************************************************************************
   123                              <1> get_font_adr:
   124                              <1> 		;---------------------------------------
   125                              <1> 		; 【スタックフレームの構築】
   126                              <1> 		;---------------------------------------
   127                              <1> 												; ------|--------
   128                              <1> 												;    + 4| パラメータバッファ
   129                              <1> 												;    + 2| IP（戻り番地）
   130 000002C5 55                  <1> 		push	bp								;  BP+ 0| BP（元の値）
   131 000002C6 89E5                <1> 		mov		bp, sp							; ------+--------
   132                              <1> 
   133                              <1> 		;---------------------------------------
   134                              <1> 		; 【レジスタの保存】
   135                              <1> 		;---------------------------------------
   136 000002C8 50                  <1> 		push	ax
   137 000002C9 53                  <1> 		push	bx
   138 000002CA 56                  <1> 		push	si
   139 000002CB 06                  <1> 		push	es
   140 000002CC 55                  <1> 		push	bp
   141                              <1> 
   142                              <1> 		;---------------------------------------
   143                              <1> 		; 引数を取得
   144                              <1> 		;---------------------------------------
   145 000002CD 8B7604              <1> 		mov		si, [bp + 4]					; dst  =FONTアドレスの保存先;
   146                              <1> 
   147                              <1> 		;---------------------------------------
   148                              <1> 		; フォントアドレスの取得
   149                              <1> 		;---------------------------------------
   150 000002D0 B83011              <1> 		mov		ax, 0x1130						; // フォントアドレスの取得
   151 000002D3 B706                <1> 		mov		bh, 0x06						; 8x16 font (vga/mcga) 
   152 000002D5 CD10                <1> 		int		10h								; ES:BP=FONT ADDRESS
   153                              <1> 
   154                              <1> 		;---------------------------------------
   155                              <1> 		; FONTアドレスを保存
   156                              <1> 		;---------------------------------------
   157 000002D7 8C04                <1> 		mov		[si + 0], es					; dst[0] = セグメント;
   158 000002D9 896C02              <1> 		mov		[si + 2], bp					; dst[1] = オフセット;
   159                              <1> 
   160                              <1> 		;---------------------------------------
   161                              <1> 		; 【レジスタの復帰】
   162                              <1> 		;---------------------------------------
   163 000002DC 5D                  <1> 		pop		bp
   164 000002DD 07                  <1> 		pop		es
   165 000002DE 5E                  <1> 		pop		si
   166 000002DF 5B                  <1> 		pop		bx
   167 000002E0 58                  <1> 		pop		ax
   168                              <1> 
   169                              <1> 		;---------------------------------------
   170                              <1> 		; 【スタックフレームの破棄】
   171                              <1> 		;---------------------------------------
   172 000002E1 89EC                <1> 		mov		sp, bp
   173 000002E3 5D                  <1> 		pop		bp
   174                              <1> 
   175 000002E4 C3                  <1> 		ret
   176                              <1> 
   111                                  
   112                                  ;************************************************************************
   113                                  ;	ブート処理の第2ステージ
   114                                  ;************************************************************************
   115                                  stage_2:
   116                                  		;---------------------------------------
   117                                  		; 文字列を表示
   118                                  		;---------------------------------------
   119 000002E5 68[5F03]E8D5FD83C4-     		cdecl	puts, .s0						; puts(.s0);
   119 000002ED 02                 
   120                                  
   121                                  		;---------------------------------------
   122                                  		; ドライブ情報を取得
   123                                  		;---------------------------------------
   124 000002EE 68[B800]E890FF83C4-     		cdecl	get_drive_param, BOOT			; get_drive_param(DX, BOOT.CYLN);
   124 000002F6 02                 
   125 000002F7 83F800                  		cmp		ax, 0							; if (0 == AX)
   126 000002FA 750C                    .10Q:	jne		.10E							; {
   127 000002FC 68[9603]E8BEFD83C4-     .10T:	cdecl	puts, .e0						;   puts(.e0);
   127 00000304 02                 
   128 00000305 E8D7FD                  		call	reboot							;   reboot(); // 再起動
   129                                  .10E:											; }
   130                                  
   131                                  		;---------------------------------------
   132                                  		; ドライブ情報を表示
   133                                  		;---------------------------------------
   134 00000308 A1[B800]                		mov		ax, [BOOT + drive.no]			; AX = ブートドライブ;
   135 0000030B 6A046A106A0268-         		cdecl	itoa, ax, .p1, 2, 16, 0b0100	; 
   135 00000312 [7703]50E8ECFE83C4-
   135 0000031A 0A                 
   136 0000031B A1[BA00]                		mov		ax, [BOOT + drive.cyln]			; 
   137 0000031E 6A046A106A0468-         		cdecl	itoa, ax, .p2, 4, 16, 0b0100	; 
   137 00000325 [7F03]50E8D9FE83C4-
   137 0000032D 0A                 
   138 0000032E A1[BC00]                		mov		ax, [BOOT + drive.head]			; AX = ヘッド数;
   139 00000331 6A046A106A0268-         		cdecl	itoa, ax, .p3, 2, 16, 0b0100	; 
   139 00000338 [8903]50E8C6FE83C4-
   139 00000340 0A                 
   140 00000341 A1[BE00]                		mov		ax, [BOOT + drive.sect]			; AX = トラックあたりのセクタ数;
   141 00000344 6A046A106A0268-         		cdecl	itoa, ax, .p4, 2, 16, 0b0100	; 
   141 0000034B [9103]50E8B3FE83C4-
   141 00000353 0A                 
   142 00000354 68[6E03]E866FD83C4-     		cdecl	puts, .s1
   142 0000035C 02                 
   143                                  
   144                                  		;---------------------------------------
   145                                  		; 次のステージへ移行
   146                                  		;---------------------------------------
   147 0000035D EB52                    		jmp		stage_3rd						; 次のステージへ移行
   148                                  
   149                                  		;---------------------------------------
   150                                  		; データ
   151                                  		;---------------------------------------
   152 0000035F 326E64207374616765-     .s0		db	"2nd stage...", 0x0A, 0x0D, 0
   152 00000368 2E2E2E0A0D00       
   153                                  
   154 0000036E 2044726976653A3078      .s1		db	" Drive:0x"
   155 00000377 20202C20433A3078        .p1		db	"  , C:0x"
   156 0000037F 202020202C20483A30-     .p2		db	"    , H:0x"
   156 00000388 78                 
   157 00000389 20202C20533A3078        .p3		db	"  , S:0x"
   158 00000391 20200A0D00              .p4		db	"  ", 0x0A, 0x0D, 0
   159                                  
   160 00000396 43616E277420676574-     .e0		db	"Can't get drive parameter.", 0
   160 0000039F 206472697665207061-
   160 000003A8 72616D657465722E00 
   161                                  
   162                                  ;************************************************************************
   163                                  ;	ブート処理の第3ステージ
   164                                  ;************************************************************************
   165                                  stage_3rd:
   166                                  		;---------------------------------------
   167                                  		; 文字列を表示
   168                                  		;---------------------------------------
   169 000003B1 68[F403]E809FD83C4-     		cdecl	puts, .s0
   169 000003B9 02                 
   170                                  
   171                                  		;---------------------------------------
   172                                  		; プロテクトモードで使用するフォントは、
   173                                  		; BIOSに内蔵されたものを流用する
   174                                  		;---------------------------------------
   175 000003BA 68[0002]E805FF83C4-     		cdecl	get_font_adr, FONT				; // BIOSのフォントアドレスを取得
   175 000003C2 02                 
   176                                  
   177                                  		;---------------------------------------
   178                                  		; フォントアドレスの表示
   179                                  		;---------------------------------------
   180 000003C3 6A046A106A0468-         		cdecl	itoa, word [FONT.seg], .p1, 4, 16, 0b0100
   180 000003CA [1104]FF36[0002]E8-
   180 000003D1 31FE83C40A         
   181 000003D6 6A046A106A0468-         		cdecl	itoa, word [FONT.off], .p2, 4, 16, 0b0100
   181 000003DD [1604]FF36[0202]E8-
   181 000003E4 1EFE83C40A         
   182 000003E9 68[0304]E8D1FC83C4-     		cdecl	puts, .s1
   182 000003F1 02                 
   183                                  
   184                                  		;---------------------------------------
   185                                  		; 処理の終了
   186                                  		;---------------------------------------
   187 000003F2 EBFE                    		jmp		$								; while (1) ; // 無限ループ
   188                                  
   189                                  		;---------------------------------------
   190                                  		; データ
   191                                  		;---------------------------------------
   192 000003F4 337264207374616765-     .s0:	db	"3rd stage...", 0x0A, 0x0D, 0
   192 000003FD 2E2E2E0A0D00       
   193                                  
   194 00000403 20466F6E7420416464-     .s1:	db	" Font Address="
   194 0000040C 726573733D         
   195 00000411 5A5A5A5A3A              .p1:	db	"ZZZZ:"
   196 00000416 5A5A5A5A0A0D00          .p2:	db	"ZZZZ", 0x0A, 0x0D, 0
   197 0000041D 0A0D00                  		db	0x0A, 0x0D, 0
   198                                  
   199                                  ;************************************************************************
   200                                  ;	パディング
   201                                  ;************************************************************************
   202 00000420 00<rep 1BE0h>           		times BOOT_SIZE - ($ - $$)		db	0	; パディング
   203                                  
